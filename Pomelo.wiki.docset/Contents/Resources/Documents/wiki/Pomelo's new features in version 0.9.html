<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo's new features in version 0.9 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448B:13C98038:5670C0E1" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="36a319fec93d6b8151eeab4bf4d7746a57cd38b9" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo-rpc-zeromq" id="user-content-pomelo-rpc-zeromq"><span class="octicon octicon-link"></span></a>Pomelo-rpc-zeromq</h2>
<p>In pomelo 0.9, we provide another rpc module based on zeromq. Besides the origin pomelo-rpc, developers can choose pomelo-rpc-zeromq. And the comparison of performance test between the origin pomelo-rpc and the pomelo-rpc-zeromq refers to: </p>
<p><a href="https://github.com/NetEase/pomelo/wiki/pomelo-rpc-zeromq%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A">pomelo-rpc-zeromq performance test report</a> </p>
<p><a href="https://github.com/NetEase/pomelo/wiki/pomelo-rpc%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A">pomelo-rpc performance test report</a>.</p>
<p>Usage：</p>
<ol>
<li><p>install zeromq.</p></li>
<li><p>configure in app.js. Specific configuration is as follow:</p></li>
</ol>
<pre><code>
var zmq = require('pomelo-rpc-zeromq');

app.configure('production|development', function() {

    app.set('proxyConfig', {
        rpcClient: zmq.client
    });

    app.set('remoteConfig', {
        rpcServer: zmq.server
    });

});

</code></pre>
<p>Use example refers to  <a href="https://github.com/NetEase/chatofpomelo/tree/zmq">chatofpomelo</a> zmq branch.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#upgrade-pomelo-command-line" id="user-content-upgrade-pomelo-command-line"><span class="octicon octicon-link"></span></a>Upgrade pomelo command line</h2>
<p>According to netizens' suggestion, in pomelo 0.9 developers can restart servers and start servers by server type using command line. These commands are as follows:</p>
<p>pomelo start -t [server type]: start some type fo servers，if you would like to start servers by server type you need to start the master server first, for example:</p>
<pre><code>
pomelo start -t master
pomelo start -t connector

</code></pre>
<p>pomelo start -i [server id]: start a certain server，like above you must start the master server first，for example：</p>
<pre><code>
pomelo start -i master
pomelo start -i chat-server-1

</code></pre>
<p>pomelo restart: restart all other servers except the master server.</p>
<p>pomelo restart -t [server type]: restart some type of servers.</p>
<p>pomelo restart -i [server id]: restart a certain server.</p>
<pre><code>
pomelo restart -t connector
pomelo restart -i chat-server-1

</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo-rpc-callback-timeout" id="user-content-pomelo-rpc-callback-timeout"><span class="octicon octicon-link"></span></a>Pomelo-rpc callback timeout</h2>
<p>Based on the issue<a href="http://nodejs.netease.com/topic/52b2d8470a516e1851b256e4">rpc callback overstock</a>, in new version of pomelo-rpc we add timeout for rpc callback. Rpc client records callbacks in application and adds corresponding timers, if rpc server receives the message and the corresponding timer will be cleared, otherwise the callback will be cleared if the message is not received in required time. And developers can set the callback timeout, default is 10s. The configuration is as follow：</p>
<pre><code>
app.set('proxyConfig', {
    timeout: 1000 * 20
});

</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#blacklist-for-connections" id="user-content-blacklist-for-connections"><span class="octicon octicon-link"></span></a>Blacklist for connections</h2>
<p>In new version of pomelo we support adding blacklist for connections both statically and dynamically, so the server side can shield attacks from clients.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#principle" id="user-content-principle"><span class="octicon octicon-link"></span></a>Principle</h3>
<p>When the connector server receives a connection from the client side, it will emit a connect event. And this event contains the client ip, the connector server will catch this event and invoke the blacklist function passed by developers. If the client ip is in blacklist, the server will kick the client.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#usage" id="user-content-usage"><span class="octicon octicon-link"></span></a>Usage</h3>
<h4>
<a aria-hidden="true" class="anchor" href="#statically" id="user-content-statically"><span class="octicon octicon-link"></span></a>statically</h4>
<p>You just need to pass a function to the connectorConfig which will return the blacklist by  callback function. This function needs a callback as its argument, and the callback function is like <code>function(err, list) {...}</code>. The usage example is as follow:</p>
<pre><code>
// ./game-server/app/util/blackList.js

var self = this;

self.blackList = ['192.168.100.1', '192.168.100.2'];

module.exports.blackListFun = function(cb) {

  cb(null, self.blackList);

};

</code></pre>
<pre><code>
// ./game-server/app.js

var blackList = require('./app/util/blackList');

app.configure('production|development', function() {

  app.set('connectorConfig', {

    blacklistFun: blackList.blackListFun
  });

}

</code></pre>
<h4>
<a aria-hidden="true" class="anchor" href="#dynamically" id="user-content-dynamically"><span class="octicon octicon-link"></span></a>dynamically</h4>
<p>Developers can add blacklist dynamically by pomelo-cli, and it supports specific ip and regular expression. The usage example is as follow:</p>
<pre><code>
blacklist 192.168.100.1
blacklist (([01]?d?d|2[0-4]d|25[0-5]).){3}([01]?d?d|2[0-4]d|25[0-5])

</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#channel-serialization-interface" id="user-content-channel-serialization-interface"><span class="octicon octicon-link"></span></a>Channel serialization interface</h2>
<p>In pomelo 0.9 we provide channel serialization interface, developers can implement these interfaces to keep channels persistent. And when the server is restarted, channels will be restored in memory. Developers need to implement four methods:</p>
<h4>
<a aria-hidden="true" class="anchor" href="#addkey-value-cb" id="user-content-addkey-value-cb"><span class="octicon octicon-link"></span></a>add(key, value, cb)</h4>
<p>add key value pairs</p>
<h4>
<a aria-hidden="true" class="anchor" href="#removekey-value-cb" id="user-content-removekey-value-cb"><span class="octicon octicon-link"></span></a>remove(key, value, cb)</h4>
<p>remove key value pairs</p>
<h4>
<a aria-hidden="true" class="anchor" href="#loadkey-cb" id="user-content-loadkey-cb"><span class="octicon octicon-link"></span></a>load(key, cb)</h4>
<p>load all values</p>
<h4>
<a aria-hidden="true" class="anchor" href="#removeallkey-cb" id="user-content-removeallkey-cb"><span class="octicon octicon-link"></span></a>removeAll(key, cb)</h4>
<p>remove all values</p>
<p>Usage:</p>
<pre><code>
var store = require('./store');

app.set('channelConfig', {
            store : store,
            prefix : 'pomelo'
        });

</code></pre>
<pre><code>//store.js

var redis = require('redis');

var StoreManager = function() {
  this.redis = redis.createClient(6379, '127.0.0.1', {});
};

module.exports = new StoreManager();

StoreManager.prototype.add = function(key, value, cb) {
  this.redis.sadd(key, value, function(err) {
    cb(err);
  });
};

StoreManager.prototype.remove = function(key, value, cb) {
  this.redis.srem(key, value, function(err) {
    cb(err);
  });
};

StoreManager.prototype.load = function(key, cb) {
    this.redis.smembers(key, function(err, list) {
        cb(err, list);
    });
};

StoreManager.prototype.removeAll = function(key, cb) {
  this.redis.del(key, function(err) {
    cb(err);
  });
};

</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#hot-restart" id="user-content-hot-restart"><span class="octicon octicon-link"></span></a>hot restart</h2>
<p>In new version of pomelo, we update the pomelo-rpc module. When the rpc server is broken, the rpc client will cache rpc requests from applications. When the rpc server is restored，the rpc requests will be flushed to the server side.</p>
<p>If there is only one-way dependency between different servers，it means only A type servers make rpc requests to B type servers, but do not have B type servers make rpc requests to A type servers. And B type servers do not have any instances, in this case B type servers can restart without any impacts.</p>
<p>Usage refers to<a href="https://github.com/NetEase/chatofpomelo">chatofpomelo</a> store branch. In chatofpomelo only connector servers make rpc requests to chat servers.For channels exsit in chat servers, we use channel serialization interface to make them persistence.</p>
<p>Operation steps are as follows:</p>
<ol>
<li>run pomelo start -t master， pomelo start -t connector, pomelo start -t gate, pomelo start -t chat in different terminals;</li>
<li>open web server，run chatofpomelo;</li>
<li>restart chat server;</li>
</ol>
<h2>
<a aria-hidden="true" class="anchor" href="#decodeio-protobuf" id="user-content-decodeio-protobuf"><span class="octicon octicon-link"></span></a>DecodeIO protobuf</h2>
<p>In pomelo 0.9, we support another protobuf implementation from decodeIO. If you do not know it, you can refer to <a href="https://github.com/dcodeIO/ProtoBuf.js">decodeIO-protobufjs</a>.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#usage-1" id="user-content-usage-1"><span class="octicon octicon-link"></span></a>Usage</h3>
<h4>
<a aria-hidden="true" class="anchor" href="#client" id="user-content-client"><span class="octicon octicon-link"></span></a>Client</h4>
<p>Use the latest pomelo-jsclient-websocket, and add pomelo-decodeIO-protobuf component in the client side, the component.js is as follow:</p>
<pre><code>
{
  "name": "boot",

  "description": "Main app boot component",

  "dependencies": {

    "component/emitter":"master",
    "NetEase/pomelo-protocol": "master",
    "pomelonode/pomelo-decodeIO-protobuf": "master",
    "pomelonode/pomelo-jsclient-websocket": "master",
    "component/jquery": "*"
  },
  "scripts": ["index.js"]
}


</code></pre>
<p>and the index.js is as follow：</p>
<pre><code>
  var Emitter = require('emitter');
  window.EventEmitter = Emitter;

  var protocol = require('pomelo-protocol');
  window.Protocol = protocol;

  var protobuf = require('pomelo-decodeIO-protobuf');
  window.decodeIO_protobuf = protobuf; 

  var pomelo = require('pomelo-jsclient-websocket');
  window.pomelo = pomelo;

  var jquery = require('jquery');
  window.$ = jquery;


</code></pre>
<h4>
<a aria-hidden="true" class="anchor" href="#server" id="user-content-server"><span class="octicon octicon-link"></span></a>Server</h4>
<p>In the server side you just need to use pomelo-protobuf-plugin, and the specific configuration is as follow：</p>
<pre><code>
app.configure('production|development', function() {

    app.use(protobuf, {
        protobuf: {
        }
    });
});

</code></pre>
<h4>
<a aria-hidden="true" class="anchor" href="#warning" id="user-content-warning"><span class="octicon octicon-link"></span></a>Warning</h4>
<p>Pomelo provides protobuf in previous version, and these protobufs cannot be used at the same time. It means that when you use pomelo-protobuf-plugin, you cannot open useProtobuf.</p>
<p>In consideration of consistence with the origin protobuf, pomelo 0.9 supports decodeIO-protobuf with serverProtos.json and clientProtos.json. Although we do not support *.proto in decodeIO-protobufjs， you can use tools provided by decodeIO-protobufjs to convert *.proto to *.json.</p>
<p>Usage example refers to <a href="https://github.com/NetEase/lordofpomelo/tree/decodeIO_protobuf">lordofpomelo</a> decodeIO-protobuf branch.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo-websocket-reconnect-automatically" id="user-content-pomelo-websocket-reconnect-automatically"><span class="octicon octicon-link"></span></a>Pomelo websocket reconnect automatically</h2>
<p>In pomelo 0.9，spomelo-jsclient-websocket can reconnect automatically. The client would reconnect when the connection lost for 5s, and the next reconnect delay time will double.For example the first reconnect delay time is 5s, the second one is 10s and so on. The default max reonnect attempts is 10, and this can be configured in app.js.</p>
<pre><code>
//reconnect configuration

pomelo.init({
        host: 127.0.0.1,
        port: 3050,
        reconnect: true
    }, function() {

});


//set max reconnect attempts

pomelo.init({
        host: 127.0.0.1,
        port: 3050,
        reconnect: true，
        maxReconnectAttempts： 20
    }, function() {

});


</code></pre>
</div>
</div></body></html>