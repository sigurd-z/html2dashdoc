<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo's new features in version 0.6 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448A:120A0A59:5670C0DC" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="2c4633c232c2d59e0e56453237024325861d33ab" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#new-features-in-pomelo-06" id="user-content-new-features-in-pomelo-06"><span class="octicon octicon-link"></span></a>New features in Pomelo 0.6</h1>
<p>Pomelo 0.6 is by far the biggest upgrade since version 0.3.</p>
<p>Pomelo 0.6 introduces plugin mechanism, and we make globalChannel and zookeeper as plugins for pomelo. Meanwhile, we provide a new interactive command-line tool which is quite convenient to do some maintenance operations. In addition, in order to enhance pomelo's safety, in pomelo 0.6 we import data signature and deal with illegal connections for hybridconnector. There are many other features, like more detailed rpc log , max connections for frontend server, servers reconnect after disconnecting from master and <a href="https://github.com/fantasyni/pomelo-daemon">pomelo-daemon</a> etc.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#interactive-command-line-tool" id="user-content-interactive-command-line-tool"><span class="octicon octicon-link"></span></a>Interactive command-line tool</h2>
<p>In order to make servers' maintenance much easier, we provide an interactive command-line tool. The detail information can be referred to <a href="https://github.com/NetEase/pomelo-cli">pomelo-cli</a> </p>
<h2>
<a aria-hidden="true" class="anchor" href="#server-connection-authorization" id="user-content-server-connection-authorization"><span class="octicon octicon-link"></span></a>Server connection authorization</h2>
<p>server connect to master with authorization<br>
pomelo-admin provides a simple auth function in <a href="https://github.com/NetEase/pomelo-admin/blob/master/lib/util/utils.js#L117">pomelo-admin auth</a><br>
developers can provide self-defined auth in pomelo by<br>
in master server</br></br></br></p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>adminAuthServerMaster<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">cb</span>){
  <span class="pl-k">if</span>(auth success) {
    <span class="pl-en">cb</span>(<span class="pl-s"><span class="pl-pds">'</span>ok<span class="pl-pds">'</span></span>);
  } <span class="pl-k">else</span> {
    <span class="pl-en">cb</span>(<span class="pl-s"><span class="pl-pds">'</span>bad<span class="pl-pds">'</span></span>);
  }
})</pre></div>
<p>in monitor server</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>adminAuthServerMonitor<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">cb</span>){
  <span class="pl-k">if</span>(auth success) {
    <span class="pl-en">cb</span>(<span class="pl-s"><span class="pl-pds">'</span>ok<span class="pl-pds">'</span></span>);
  } <span class="pl-k">else</span> {
    <span class="pl-en">cb</span>(<span class="pl-s"><span class="pl-pds">'</span>bad<span class="pl-pds">'</span></span>);
  }
})</pre></div>
<p><strong>note</strong>: by default you should provide adminServer.json file under the <strong>config</strong> dir<br>
adminServer.json</br></p>
<pre><code>[{
    "type": "connector",
    "token": "agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn"
}, {
    "type": "chat",
    "token": "agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn"
},{
    "type": "gate",
    "token": "agarxhqb98rpajloaxn34ga8xrunpagkjwlaw3ruxnpaagl29w4rxn"
}
]
</code></pre>
<p><strong>type</strong> is the serverType, <strong>token</strong> is a string you can genrate by yourself<br>
when using in pomelo, you should fill all your servers with type:token  </br></p>
<h2>
<a aria-hidden="true" class="anchor" href="#plugin" id="user-content-plugin"><span class="octicon octicon-link"></span></a>Plugin</h2>
<p>In order to make the developers customize the framework, we introduces the plugin mechanism to pomelo. The detail information can be referred to <a href="https://github.com/NetEase/pomelo/wiki/plugin%E6%96%87%E6%A1%A3">plugin</a>.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#connections-encryption" id="user-content-connections-encryption"><span class="octicon octicon-link"></span></a>Connections encryption</h2>
<p>In pomelo 0.6, we provide data signature for hybridconnector. The following is how it works:</p>
<ul>
<li>Firstly, the client generates rsa key pair and it would keep the private key; </li>
<li>Then the server would get the public key during the handshake phrase</li>
<li>Thirdly, the client would send the message and the signature which is signed by the private key in the client side to the server</li>
<li>Finally, the server would verify the signature with the public key from the client. The detail flow is as following chart:</li>
</ul>
<p><img alt="rsa" data-canonical-src="http://pomelo.netease.com/resource/documentImage/rsa.png" src="https://camo.githubusercontent.com/62961590fa25e5a629dee6f8cdcf2a23da15f13c/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f7273612e706e67"/></p>
<h3>
<a aria-hidden="true" class="anchor" href="#how-to-use" id="user-content-how-to-use"><span class="octicon octicon-link"></span></a>How to use</h3>
<p>You need to add an option 'encrypt' on both client and server as below:</p>
<p>client</p>
<pre lang="javascript```"><code>pomelo.init({
 host:'127.0.0.1',
 port:3014,
 encrypt:true
}, function() {
// do something connected
});
</code></pre>
<p>server</p>
<pre lang="javascript```"><code>app.set('connectorConfig', {
 connector: pomelo.connectors.hybridconnector,
 heartbeat: 3,
 useDict: true,
 useProtobuf: true,
 useCrypto: true
});
</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#illegal-connections" id="user-content-illegal-connections"><span class="octicon octicon-link"></span></a>Illegal connections</h2>
<p>In pomelo sioconnector is based on socket.io, and socket.io itself has dealt with illegal connections. For hybridconnector is based on socket which does not do anything about illegal connections, we have dealt with this problem in pomelo 0.6, including empty connections and connections which do not meet with pomelo protocol standard.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#rpc-debug-log" id="user-content-rpc-debug-log"><span class="octicon octicon-link"></span></a>Rpc debug log</h2>
<p>According to pomelo developers' suggestion, we add more logs in pomelo-rpc. Developers only need to add app.enable('rpcDebugLog') in app.js, and modify game-server/config/servers.json as follow code:</p>
<pre lang="json```"><code>{
 "type": "file",
 "filename": "./logs/rpc-debug-${opts:serverId}.log",
 "fileSize": 1048576,
 "layout": {
  "type": "basic"
 },
 "backups":5,
 "category": "rpc-debug"
}
</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#overload-protection" id="user-content-overload-protection"><span class="octicon octicon-link"></span></a>Overload protection</h2>
<p>We have toobusy module to protect servers from overload in pomelo, and in new edition we add a feature to limit the max connections of frontend server. When the frontend server's connections exceed the max connections, it would refuse new connections. The configure code is as follow:</p>
<pre lang="json```"><code>{"id":"connector-server-1", "host":"127.0.0.1", "port":4050, "clientPort":3050, "frontend":true, "max-connections": 100}
</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#servers-reconnect-after-disconnecting" id="user-content-servers-reconnect-after-disconnecting"><span class="octicon octicon-link"></span></a>Servers reconnect after disconnecting</h2>
<p>In distributed environment, there exists situations that servers(not master) disconnect from intranet. When the server recovers from disconnecting, it would also has problems for the whole system. So we have solved this problem in pomelo 0.6.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#daemon-start-mode" id="user-content-daemon-start-mode"><span class="octicon octicon-link"></span></a>Daemon start mode</h2>
<p>We provide <a href="https://github.com/NetEase/pomelo-daemon">pomelo-daemon</a> for pomelo services to deploy better in distributed enviroment, besides, pomelo-daemon provides rpc debug log collector to sync log files to mongodb. The detail information can refer to <a href="https://github.com/NetEase/pomelo-daemon">pomelo-daemon</a></p>
<h2>
<a aria-hidden="true" class="anchor" href="#updated-logger" id="user-content-updated-logger"><span class="octicon octicon-link"></span></a>Updated logger</h2>
<p>we update new version of logger.</p>
<ul>
<li>logger supports prefix appended ahead of log, prefix can be filename, serverId, host etc<br>
</br></li>
<li>logger support output line in debug environment<br>
</br></li>
<li>in pomelo, logger will output to appender named by <strong>pomelo</strong><br>
The detail information can refer to <a href="https://github.com/NetEase/pomelo-logger">pomelo-daemon</a> </br></li>
</ul>
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo-protobuf-provides-support-for-rootmsg-defined-protos" id="user-content-pomelo-protobuf-provides-support-for-rootmsg-defined-protos"><span class="octicon octicon-link"></span></a>pomelo-protobuf provides support for rootMsg defined protos</h2>
<pre><code>{
  "message Path": {
    "required double x" : 1,
    "required double y" : 2
  },
  "message Equipment" : {
    "required uInt32 entityId" : 1,
    "required uInt32 kindId" : 2
  },
  "onMove" : {
    "required uInt32 entityId" : 1,
    "repeated Path path" : 2,
    "required float speed" : 3
  },
  "area.playerHandler.enterScene" : {
    "message Player" : {
      "message Bag" : {
        "message Item" : {
          "required uInt32 id" : 1,
          "optional string type" : 2
        },
        "repeated Item items" : 1
      },
      "required uInt32 entityId" : 1,
      "required uInt32 kindId" : 2,
      "required Bag bag" : 3,
      "repeated Equipment equipments" : 4
    },
    "optional Player curPlayer" : 2
  }
}
</code></pre>
<p>In this example, Path, Equipment is root message. It can be reused in the whole definition.
With rootMsg defined in protos, developers can write proto files easier. The detail information can refer to <a href="https://github.com/pomelonode/pomelo-protobuf#rootmessage-support">pomelo-protobuf</a></p>
</div>
</div></body></html>