<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo 通讯协议 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448C:146C3C14:5670C0D5" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="db9b24514aa999e19857961826c3a45418d78102" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE" id="user-content-pomelo通讯协议"><span class="octicon octicon-link"></span></a>Pomelo通讯协议</h2>
<h3>
<a aria-hidden="true" class="anchor" href="#%E8%83%8C%E6%99%AF" id="user-content-背景"><span class="octicon octicon-link"></span></a>背景</h3>
<p>0.3版本之前的Pomelo采用json格式的文本作为客户端和服务器的通讯协议，方便协议定制和修改，但同时也带来了较多的通讯冗余数据。Pomelo在0.3版本，底层通讯提供了二进制版本通讯协议的支持，同时提供了route字典压缩和protobuf压缩，提高带宽利用率，以满足诸如移动环境的需求。同时上层接口仍保持json格式的接口，对0.3版本之前的代码不产生任何影响，也保留了开发的便利。</p>
<p>Pomelo的二进制协议包含两层编码：package和message。Message层主要实现route压缩和protobuf压缩，message层的编码结果将传递给package层。Package层主要实现Pomelo应用基于二进制协议的握手过程，心跳和数据传输编码，package层的编码结果可以通过tcp，websocket等协议以二进制数据的形式进行传输。Message层编码可选，也可替换成其他二进制编码格式，都不影响package层编码和发送。</p>
<p>Pomelo协议层的结构如下图所示：</p>
<img alt="Pomelo Protocol" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/Data%20transport.png" src="https://camo.githubusercontent.com/3c3a9b28071220fe15a3c3666d7d088fe1a227de/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f446174612532307472616e73706f72742e706e67">
<h3>
<a aria-hidden="true" class="anchor" href="#pomelo-package" id="user-content-pomelo-package"><span class="octicon octicon-link"></span></a>Pomelo Package</h3>
<p>Package协议主要用来封装在面向连接的二进制流的通讯协议（如：tcp）上的Pomelo数据包。Package分为控制包和数据包两种类型。前者用来实现Pomelo应用层面的控制流程，包括客户端和服务器的握手，心跳和服务器主动断开连接的通知等控制信息。后者则是用来在客户端和服务器之间传输应用数据。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#package%E6%A0%BC%E5%BC%8F" id="user-content-package格式"><span class="octicon octicon-link"></span></a>Package格式</h4>
<p>Package分为header和body两部分。Header描述package包的类型和包的长度，body则是需要传输的数据内容。具体格式如下：</p>
<img alt="pomelo package" data-canonical-src="http://pomelo.netease.com/resource/documentImage/pomelo-package.png" src="https://camo.githubusercontent.com/d5dff0a6494b53e5ad45d1aa98341b8e6db6d598/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f706f6d656c6f2d7061636b6167652e706e67">
<ul>
<li>type - package类型，1个byte，取值如下。

<ul>
<li>0x01: 客户端到服务器的握手请求以及服务器到客户端的握手响应</li>
<li>0x02: 客户端到服务器的握手ack</li>
<li>0x03: 心跳包</li>
<li>0x04: 数据包</li>
<li>0x05: 服务器主动断开连接通知</li>
</ul>
</li>
<li>length - body内容长度，3个byte的大端整数。</li>
<li>body - 二进制的传输内容。</li>
</ul>
<p>各个package类型的具体描述和控制流程如下。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E6%8F%A1%E6%89%8B" id="user-content-握手"><span class="octicon octicon-link"></span></a>握手</h4>
<p>握手流程主要提供一个机会，让客户端和服务器在连接建立后，进行一些初始化的数据交换。交换的数据分为系统和用户两部分。系统部分为Pomelo框架所需信息，用户部分则是用户可以在具体应用中自定义的内容。</p>
<p>握手的内容为utf-8编码的json字符串（不压缩），通过body字段传输。</p>
<p>握手请求：</p>
<pre><code>{
  'sys': {
    'version': '1.1.1',
    'type': 'js-websocket'
  }, 
  'user': {
    // any customized request data
  }
}
</code></pre>
<ul>
<li>sys.version - 客户端的版本号。每个客户端SDK的每一个版本都有一个固定的版本号。在握手阶段客户端将该版本号上传给服务器，服务器可以由此来判断当前客户端是否合适与服务器通讯。</li>
<li>sys.type - 客户端的类型。可以通过客户端类型和版本号一起来确定客户端是否合适。</li>
</ul>
<p>握手响应：</p>
<pre><code>{
  'code': 200,          // result code
  'sys': {
    'heartbeat': 3,     // heartbeat interval in second
    'dict': {},         // route dictionary
    'protos': {}        // protobuf definition data
  }, 
  'user': {
    // any customized response data
  }
}
</code></pre>
<ul>
<li>code - 握手响应的状态码。目前的取值：200代表成功，500为处理用户自定义握手流程时失败，501为客户端版本号不符合要求。</li>
<li>sys.heartbeat - 可选，心跳时间间隔，单位为秒，没指定表示不需要心跳。</li>
<li>dict - 可选，route字段压缩的映射表，没指定表示没有字典压缩。</li>
<li>protos - 可选，protobuf压缩的数据定义，没有表示protobuf压缩。</li>
<li>user - 可选，用户自定义的握手数据，没有表示没有用户自定义的握手数据。</li>
</ul>
<p>握手的流程如下：</p>
<img alt="handshake" data-canonical-src="http://pomelo.netease.com/resource/documentImage/pomelo-handshake.png" src="https://camo.githubusercontent.com/577b3255b705d645fe2ad5647b95e0ff599900da/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f706f6d656c6f2d68616e647368616b652e706e67">
<p>当底层连接建立后，客户端向服务器发起握手请求，并附带必要的数据。服务器检验握手数据后，返回握手响应。如果握手成功，客户端向服务器发送一个握手ack，握手阶段至此成功结束。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E5%BF%83%E8%B7%B3" id="user-content-心跳"><span class="octicon octicon-link"></span></a>心跳</h4>
<p>心跳包的length字段为0，body为空。</p>
<p>心跳的流程如下：</p>
<img alt="heartbeat" data-canonical-src="http://pomelo.netease.com/resource/documentImage/pomelo-heartbeat.png" src="https://camo.githubusercontent.com/4d221f97ad9c332a976baf43c0e6c0e21363af0a/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f706f6d656c6f2d6865617274626561742e706e67">
<p>服务器可以配置心跳时间间隔。当握手结束后，服务器发起第一个心跳。服务器和客户端收到心跳包后，延迟心跳间隔的时间后再向对方发送一个心跳包。</p>
<p>心跳超时时间为2倍的心跳间隔时间。服务器检测到心跳超时并不会主动断开客户端的连接。客户端检测到心跳超时，可以根据策略选择是否要主动断开连接。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E6%95%B0%E6%8D%AE" id="user-content-数据"><span class="octicon octicon-link"></span></a>数据</h4>
<p>数据包用来在客户端和服务器之间传输数据所用。数据包的body是由上层传下来的任意二进制数据，package层不会对body内容做任何处理。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E5%8A%A8%E6%96%AD%E5%BC%80" id="user-content-服务器主动断开"><span class="octicon octicon-link"></span></a>服务器主动断开</h4>
<p>当服务器主动断开客户端连接时（如：踢掉某个在线玩家），会先向客户端发送一个控制消息，然后再断开连接。客户端可以通过这个消息来判断是否是服务器主动断开连接的。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#pomelo-message" id="user-content-pomelo-message"><span class="octicon octicon-link"></span></a>Pomelo Message</h3>
<p>Message 协议的主要作用是封装消息头，包括route和消息类型两部分，不同的消息类型有着不同的消息头。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#message-%E5%A4%B4%E6%A0%BC%E5%BC%8F" id="user-content-message-头格式"><span class="octicon octicon-link"></span></a>Message 头格式</h4>
<p>消息头分为三部分，flag，message id，route。如下图所示：</p>
<img alt="Message Head" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/MessageHead.png" src="https://camo.githubusercontent.com/a61e4e7b751af6ebc476b48a42ff94a7fdbf744c/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f4d657373616765486561642e706e67">
<p>从上图可以看出，Pomelo消息头是可变的，会根据具体的消息类型和内容而改变。其中，flag位是必须的，占用一个byte，它决定了后面的消息类型和内容的格式。message id和route则是可选的。其中Message id采用variant 128变长编码方式，根据值的大小，长度在0～5byte之间。Route则根据消息类型以及内容的大小，长度在0～255byte之间。</p>
<h5>
<a aria-hidden="true" class="anchor" href="#%E6%A0%87%E5%BF%97%E4%BD%8Dflag" id="user-content-标志位flag"><span class="octicon octicon-link"></span></a>标志位Flag</h5>
<p>Flag占用Message头的第一个byte，其内容如下</p>
<img alt="flag" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/MessageFlag.png" src="https://camo.githubusercontent.com/9a940e05b8cf0f76374a7879b1cbecac35a11334/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f4d657373616765466c61672e706e67">
<p>现在只用到了其中的4个bit，这四个bit包括两部分，占用3个bit的message type字段和占用1个bit的route标识，其中：</p>
<ul>
<li>message type用来标识消息类型,范围为0～7，现在消息共有四类，request，notify，response，push，值的范围是0～3。不同的消息类型有着不同的消息内容，下面会有详细分析。</li>
<li>最后一位的route表示route是否压缩，影响route字段的长度。
这两部分之间相互独立，互不影响。</li>
</ul>
<h5>
<a aria-hidden="true" class="anchor" href="#%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8Bmessage-type-%E8%A7%A3%E6%9E%90" id="user-content-消息类型message-type-解析"><span class="octicon octicon-link"></span></a>消息类型Message Type 解析</h5>
<p>Message type与消息类型的关系如下表：</p>
<img alt="Message Type" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/MessageType.png" src="https://camo.githubusercontent.com/0152a96bccc8fb9b0f28b51b8bc9a034f0fe0bdb/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f4d657373616765547970652e706e67">
<p>不同的消息类型对应着不同的消息头，具体的对应关系如下图：</p>
<img alt="Message Head Content" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/MessageHeadContent.png" src="https://camo.githubusercontent.com/8c6e2adfa3412f55df88ff72a4f4e9d82055e25f/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f4d65737361676548656164436f6e74656e742e706e67">
<h5>
<a aria-hidden="true" class="anchor" href="#route%E6%A0%87%E5%BF%97%E4%BD%8D" id="user-content-route标志位"><span class="octicon octicon-link"></span></a>Route标志位</h5>
<p>route主要分为压缩和未压缩两种，由flag的最后一位（route位）指定，当flag中的route标志为0时，表示未压缩的route，为1则表示是压缩route。route通过系统生成和用户自定义的字典进行压缩，具体内容见（pomelo压缩协议-字典压缩）。</p>
<img alt="Message Type" data-canonical-src="http://pomelo.netease.com/resource/documentImage/protocol/MessageRoute.png" src="https://camo.githubusercontent.com/cfb26e336222d6165d0eed77749e0c5cd5eb3b00/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f70726f746f636f6c2f4d657373616765526f7574652e706e67">
<p>上图是不同的flag标志对应的route字段的内容：</p>
<ul>
<li>flag的最后一位为1时，后面跟的是一个uInt16表示的route字典编号，需要通过查询字典来获取route。</li>
<li>flag最后一位为0是，后面第一位uInt8的byte，用来表示route的字节长度。之后是通过utf8编码后的route，其长度就是前面一位byte的uInt8的值。</li>
</ul>
</img></img></img></img></img></img></img></img></img></div>
</div></body></html>