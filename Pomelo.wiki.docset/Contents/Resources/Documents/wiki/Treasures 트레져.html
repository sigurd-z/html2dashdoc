<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Treasures 트레져 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="7250A4CA:6926:ECE1451:5670C155" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="6318a3c25e5fc68b365e6f345a750a01cd4a17d2" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#treasures" id="user-content-treasures"><span class="octicon octicon-link"></span></a>Treasures</h1>
<h2>
<a aria-hidden="true" class="anchor" href="#description" id="user-content-description"><span class="octicon octicon-link"></span></a>Description</h2>
<p><a href="https://github.com/NetEase/treasures">Treasures</a> game which extracted from the game <a href="https://github.com/NetEase/lordofpomelo">LordOfPomelo</a> and remove a lot of game logic, in order to show the working principle and usage of the <a href="https://github.com/NetEase/pomelo">Pomelo</a> framework more clearly.</p>
<p>Treasures is very simple, just enter a name, a game character will be randomly generated, and then enter the game scene. Some treasures scattered ground in the game scene , each treasure have score, the player operate the game characters to pick up the treasures, and then will be able to get the scores.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#%EC%84%A4%EB%AA%85" id="user-content-설명"><span class="octicon octicon-link"></span></a>설명</h2>
<p><a href="https://github.com/NetEase/pomelo">Pomelo</a> 프레임워크의 보다 명확한 사용법과 동작 원리를 보여주기 위해서 <a href="https://github.com/NetEase/lordofpomelo">LordOfPomelo</a> 게임에서 많은 게임 로직을 제거하고 추출한 <a href="https://github.com/NetEase/treasures">Treasures</a> 게임입니다.</p>
<p>이름을 입력하고, 램덤으로 게임 캐릭터가 생성되고, 게임 화면이 시작되는 Treasures는 아주 간단합니다. 게임 화면에는 보물들이 흩어져 있고 각 보물에는 점수가 있는데, 플레이어는 게임 캐릭터를 조종해서 보물을 찾고 점수를 획득 할 수 있습니다.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#install-and-run" id="user-content-install-and-run"><span class="octicon octicon-link"></span></a>Install and Run</h2>
<p>Install <code>pomelo</code> with <code>npm</code></p>
<div class="highlight highlight-source-shell"><pre>npm install -g pomelo</pre></div>
<p>Get the source code</p>
<div class="highlight highlight-source-shell"><pre>git clone git@github.com:NetEase/treasures.git</pre></div>
<p>Install the dependencies (enter the project directory first)</p>
<div class="highlight highlight-source-shell"><pre>sh npm-install.sh</pre></div>
<p>Start the <code>web-server</code>  (enter the <code>web-server</code> directory first)</p>
<div class="highlight highlight-source-shell"><pre>node app.js</pre></div>
<p>Start the <code>game-server</code> (enter the <code>game-server</code> directory first)</p>
<div class="highlight highlight-source-shell"><pre>pomelo start</pre></div>
<p>visit <a href="http://localhost:3001">http://localhost:3001</a> in your modern brower(the latest chrome is best), and enter the game.</p>
<p>You can get more details with Pomelo's <a href="https://github.com/NetEase/pomelo/wiki/Quick-start-guide">quick start guide</a></p>
<p>And another <a href="https://github.com/NetEase/pomelo/wiki/Distributed%20Chat">tutorial</a> for study.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#%EC%84%A4%EC%B9%98%EC%99%80-%EC%8B%A4%ED%96%89" id="user-content-설치와-실행"><span class="octicon octicon-link"></span></a>설치와 실행</h2>
<p><code>npm</code>으로 <code>pomelo</code>설치</p>
<div class="highlight highlight-source-shell"><pre>npm install -g pomelo</pre></div>
<p>소스 코드 얻기</p>
<div class="highlight highlight-source-shell"><pre>git clone git@github.com:NetEase/treasures.git</pre></div>
<p>의존 관련 설치(dependencies) (프로젝트 디렉토리로 이동 후에)</p>
<div class="highlight highlight-source-shell"><pre>sh npm-install.sh</pre></div>
<p><code>web-server</code> 시작하기 (<code>web-server</code> 디렉토리로 이동 후에)</p>
<div class="highlight highlight-source-shell"><pre>node app.js</pre></div>
<p><code>game-server</code> 시작하기 (<code>game-server</code> 디렉토리로 이동 후에)</p>
<div class="highlight highlight-source-shell"><pre>pomelo start</pre></div>
<p>모던한 브라우져(최신 크롬이 가장 적합함)로 <a href="http://localhost:3001">http://localhost:3001</a> 접속하고, 게임을 시작합니다.</p>
<p>Pomelo's <a href="https://github.com/NetEase/pomelo/wiki/Quick-start-guide">quick start guide</a> 에서 자세한 사항을 확인 할 수 있습니다.</p>
<p>그리도 또 다른 <a href="https://github.com/NetEase/pomelo/wiki/Distributed%20Chat">tutorial</a> 스터디 자료가 있습니다.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#architecture" id="user-content-architecture"><span class="octicon octicon-link"></span></a>Architecture</h2>
<p>Treasures  has 2 parts which are <code>web-Server</code> and <code>game-Server</code>.</p>
<ul>
<li><p><code>web-server</code> is a simple http server, based on Express</p></li>
<li><p><code>game-server</code> is a webSocket server for running the game logic</p></li>
</ul>
<p>Let's have a look at the architecture of the <code>game-server</code> from the config file <code>game-server/config/server.json</code></p>
<h2>
<a aria-hidden="true" class="anchor" href="#%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98" id="user-content-아키텍처"><span class="octicon octicon-link"></span></a>아키텍처</h2>
<p>Treasures는 <code>web-Server</code>와 <code>game-Server</code> 두 부분이 있습니다.</p>
<ul>
<li><p><code>web-server</code> 는 간단한 Express 기반의 http 서버입니다.</p></li>
<li><p><code>game-server</code> 는 게임 로직을 실행하기 위한 webSocket 서버입니다.
<code>game-server/config/server.json</code> 설정 파일에서 <code>game-server</code>의 아키텍처를 확인해 봅시다.</p></li>
</ul>
<div class="highlight highlight-source-js"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>development<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>connector<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>connector-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3150</span>, <span class="pl-s"><span class="pl-pds">"</span>wsPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3010</span>},
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>connector-server-2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3151</span>, <span class="pl-s"><span class="pl-pds">"</span>wsPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3011</span>}
    ],
    <span class="pl-s"><span class="pl-pds">"</span>area<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>area-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3250</span>, <span class="pl-s"><span class="pl-pds">"</span>areaId<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span>}
    ],
    <span class="pl-s"><span class="pl-pds">"</span>gate<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>gate-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>wsPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3014</span>}
    ]
  }
}</pre></div>
<p>It can be seen that the server side is constituted by the following components:</p>
<ul>
<li>2 <code>connector</code> servers, for receiving and sending messages.</li>
<li>A <code>gate</code> server is mainly used for load balancing which dispatch the connections to the <code>connector</code> servers.</li>
<li>An <code>area</code> server used to drive the game scene, and the game logic.</li>
</ul>
<p>The relationship between the servers, as the following diagram:</p>
<p>서버 사이드는 아래 컴포넌트들로 구성되는 것으로 볼 수 있습니다.</p>
<ul>
<li>2개의 <code>connector</code> 서버는 메시지를 받기(receiving ) 보내기(sending)를 합니다.</li>
<li>1개의 <code>gate</code> 서버는 <code>connector</code> 서버들의 연결을 처리하는 로드 밸런싱에 주로 사용 됩니다.</li>
<li>1개의 <code>area</code> 서버는 게임 화면과 게임 로직을 만듭니다. </li>
</ul>
<p><img alt="treasure-arch" data-canonical-src="http://pomelo.netease.com/resource/documentImage/treasure-arch.png" src="https://camo.githubusercontent.com/c2fb2d78ea8b90ed2ee5fea5a3e7670a1e8b7f2f/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f74726561737572652d617263682e706e67"/></p>
<h2>
<a aria-hidden="true" class="anchor" href="#source-code-analysis" id="user-content-source-code-analysis"><span class="octicon octicon-link"></span></a>Source code analysis</h2>
<p>Analyzed the code by the flow of the game.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#1-connect-to-the-server" id="user-content-1-connect-to-the-server"><span class="octicon octicon-link"></span></a>1. Connect to the server</h3>
<p>clinet: <code>web-server/public/js/main.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>gate.gateHandler.queryEntry<span class="pl-pds">'</span></span>, {uid<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">//...</span>
});</pre></div>
<p>server: <code>game-server/app/servers/gate/handler/gateHandler.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">Handler</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">queryEntry</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// return the host and port of the connector server</span>
  <span class="pl-en">next</span>(<span class="pl-c1">null</span>, {code<span class="pl-k">:</span> <span class="pl-smi">Code</span>.<span class="pl-c1">OK</span>, host<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-c1">host</span>, port<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-smi">wsPort</span>});
};</pre></div>
<p>So that the client will be able to connect to the <code>connector</code> server</p>
<h2>
<a aria-hidden="true" class="anchor" href="#%EA%B2%8C%EC%9E%84-%EC%86%8C%EC%8A%A4-%EB%B6%84%EC%84%9D" id="user-content-게임-소스-분석"><span class="octicon octicon-link"></span></a>게임 소스 분석</h2>
<p>게임의 흐름에 따라 소스를 분석하겠습니다.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#1-%EC%84%9C%EB%B2%84%EC%97%90-%EC%97%B0%EA%B2%B0%ED%95%98%EA%B8%B0" id="user-content-1-서버에-연결하기"><span class="octicon octicon-link"></span></a>1. 서버에 연결하기</h3>
<p>클라이언트: <code>web-server/public/js/main.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>gate.gateHandler.queryEntry<span class="pl-pds">'</span></span>, {uid<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">//...</span>
});</pre></div>
<p>서버: <code>game-server/app/servers/gate/handler/gateHandler.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">Handler</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">queryEntry</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// connector 서버의 host, port 리턴</span>
  <span class="pl-en">next</span>(<span class="pl-c1">null</span>, {code<span class="pl-k">:</span> <span class="pl-smi">Code</span>.<span class="pl-c1">OK</span>, host<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-c1">host</span>, port<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-smi">wsPort</span>});
};</pre></div>
<p>그럼 클라이언트는 <code>connector</code>서버와 연결을 할 수 있습니다.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#2-enter-the-game" id="user-content-2-enter-the-game"><span class="octicon octicon-link"></span></a>2. Enter the Game</h3>
<p>After establishing a connection with the <code>connector</code> server, began to enter the game.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>When the client sends a request to the <code>connector</code> server for the first time, the server will initialize a <code>session</code> bind with some events.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// session bind with playerId</span>
<span class="pl-smi">session</span>.<span class="pl-en">bind</span>(playerId);
<span class="pl-c">// set player's areaId</span>
<span class="pl-smi">session</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>);</pre></div>
<p>The client send a request to the server for entering game scene</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">"</span>area.playerHandler.enterScene<span class="pl-pds">"</span></span>, {name<span class="pl-k">:</span> name, playerId<span class="pl-k">:</span> <span class="pl-smi">data</span>.<span class="pl-smi">playerId</span>}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>After the client sends a request to the server, the request will reach the <code>connector</code> server at first, and the <code>connector</code> server route the request to the appropriate server <code>area</code> (There is only one <code>area</code> server in this example) according to the route rules(<code>game-server/app/util/routeUtil.js</code>). And then <code>playerHandler</code> in <code>area</code> server treating the corresponding request. Players added to the game scene.</p>
<p>After a player is added to the game scene, the other players must be able to see the player to join in real time, so the server must broadcast the message to all players in this game scene.</p>
<p>Create a channel, all players in this game scene will be added to the channel.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// get the channel. If there is no channel exsit, create one.</span>
channel <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>channelService<span class="pl-pds">'</span></span>).<span class="pl-en">getChannel</span>(<span class="pl-s"><span class="pl-pds">'</span>area_<span class="pl-pds">'</span></span> <span class="pl-k">+</span> id, <span class="pl-c1">true</span>);
<span class="pl-c">// add the player to channel</span>
<span class="pl-smi">channel</span>.<span class="pl-c1">add</span>(<span class="pl-smi">e</span>.<span class="pl-c1">id</span>, <span class="pl-smi">e</span>.<span class="pl-smi">serverId</span>);</pre></div>
<p>When someone joins or state changes, these messages will be pushed to each player in this area. 
For example, a player join the area</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">channel</span>.<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, entities<span class="pl-k">:</span> added});</pre></div>
<p>These messages are sent to the client through the <code>connector</code> server. And the <code>area</code> determine which <code>connector</code> server sent out by <code>session.frontendId</code>.</p>
<p>The client accept messages:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// When new players to join, the server will broadcast a message to all players. The client bind through this route, to get the message </span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#2-%EA%B2%8C%EC%9E%84-%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0" id="user-content-2-게임-들어가기"><span class="octicon octicon-link"></span></a>2. 게임 들어가기</h3>
<p><code>connector</code> 서버와 연결이 확인된 후에, 게임이 시작 됩니다. </p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>먼저 클라이언트에서 <code>connector</code> 서버로 요청을 보내면, 서버는 약간은 이벤트들을 묶어서 <code>session</code>을 초기화 할 것입니다.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// session bind with playerId</span>
<span class="pl-smi">session</span>.<span class="pl-en">bind</span>(playerId);
<span class="pl-c">// set player's areaId</span>
<span class="pl-smi">session</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>);</pre></div>
<p>클라이언트는 게임 화면에 들어가면서 서버에 요청을 보냅니다. </p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">"</span>area.playerHandler.enterScene<span class="pl-pds">"</span></span>, {name<span class="pl-k">:</span> name, playerId<span class="pl-k">:</span> <span class="pl-smi">data</span>.<span class="pl-smi">playerId</span>}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>클라이언트가 서버에 요청을 보낸 후, 먼저 요청은 <code>connector</code> 서버에 도달할 것이고, <code>connector</code> 서버는 적절한 'area'서버에 요청을 전송할 것입니다.(이 예제에는 <code>area</code>서버가 오직 한개만 있습니다.). 그 다음 <code>area</code>서버의 <code>playerHandler</code> 가 해당 요청을 처리합니다. 플레이어는 게임 화면에 나오게 됩니다.</p>
<p>플레이어가 게임 화면에 나온 후에, 다른 플레이어는 실시간으로 참여한 플레이어를 볼 수 있어야 합니다. 그래서 서버는 게임 화면의 모든 플레이어에게 메시지를 전파 해야 합니다.</p>
<p>게임 화면에 있는 모든 플레이어가 추가 될 채널을 만듭니다.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// get the channel. If there is no channel exsit, create one.</span>
channel <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>channelService<span class="pl-pds">'</span></span>).<span class="pl-en">getChannel</span>(<span class="pl-s"><span class="pl-pds">'</span>area_<span class="pl-pds">'</span></span> <span class="pl-k">+</span> id, <span class="pl-c1">true</span>);
<span class="pl-c">// add the player to channel</span>
<span class="pl-smi">channel</span>.<span class="pl-c1">add</span>(<span class="pl-smi">e</span>.<span class="pl-c1">id</span>, <span class="pl-smi">e</span>.<span class="pl-smi">serverId</span>);</pre></div>
<p>누군가 참여하거나 상태가 변경되면 이런 메시지는 이 구역의 각 플레이어에게 보내(pushed)지게 됩니다.
예를들어, 한 플레이어가 이 area에 참여합니다.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">channel</span>.<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, entities<span class="pl-k">:</span> added});</pre></div>
<p>이 메시지들은 <code>connector</code> 서버를 통해 클라이언트에 보내집니다. 그리고 <code>area</code>는 <code>session.frontendId</code>를 통해 어떤 <code>connector</code> 서버에 보낼지 결정 합니다.</p>
<p>클라이언트는 메시지를 받습니다:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// When new players to join, the server will broadcast a message to all players. The client bind through this route, to get the message </span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#3-area-server" id="user-content-3-area-server"><span class="octicon octicon-link"></span></a>3. Area Server</h3>
<p>Are server is a tick-driven game scenes. Each tick will update the status of the entity in the scene, and if the state has changed, these changes will be pushed to the client.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">function</span> <span class="pl-en">tick</span>() {
  <span class="pl-c">//run all the action</span>
  <span class="pl-smi">area</span>.<span class="pl-en">actionManager</span>().<span class="pl-en">update</span>();
  <span class="pl-c">// update entities</span>
  <span class="pl-smi">area</span>.<span class="pl-en">entityUpdate</span>();
  <span class="pl-c">// update rank</span>
  <span class="pl-smi">area</span>.<span class="pl-en">rankUpdate</span>();
}</pre></div>
<p>A player do a <code>move</code> action
client:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a `move` request to server</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<p>server:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// in playerHandler</span>
<span class="pl-c1">handler</span>.<span class="pl-en">move</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// create a move action</span>
  <span class="pl-k">var</span> action <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Move</span>({
    entity<span class="pl-k">:</span> player,
    endPos<span class="pl-k">:</span> endPos,
  });
});</pre></div>
<p>And this <code>action</code> will update in next <code>tick</code>.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#3-area-%EC%84%9C%EB%B2%84" id="user-content-3-area-서버"><span class="octicon octicon-link"></span></a>3. Area 서버</h3>
<p>Area 서버는 틱(tick) 방식의 게임 구성입니다. 각 틱은 장면의 엔티티 상태를 업데이트하고, 상태가 변경되면 클라이언트에게 푸쉬됩니다.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">function</span> <span class="pl-en">tick</span>() {
  <span class="pl-c">//모든 액션을 실행 합니다.</span>
  <span class="pl-smi">area</span>.<span class="pl-en">actionManager</span>().<span class="pl-en">update</span>();
  <span class="pl-c">// 엔티티 업데이트</span>
  <span class="pl-smi">area</span>.<span class="pl-en">entityUpdate</span>();
  <span class="pl-c">// 랭크 업데이트</span>
  <span class="pl-smi">area</span>.<span class="pl-en">rankUpdate</span>();
}</pre></div>
<p>플레이어가 <code>move</code> 액션을 합니다.
클라이언트:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// `move` 요청을 서버에 보냅니다</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<p>서버:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// playerHandler 에서</span>
<span class="pl-c1">handler</span>.<span class="pl-en">move</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// 움직이는 액션을 만듭니다</span>
  <span class="pl-k">var</span> action <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Move</span>({
    entity<span class="pl-k">:</span> player,
    endPos<span class="pl-k">:</span> endPos,
  });
});</pre></div>
<p>이 <code>action</code>은 다음 <code>tick</code>를 업데이트 합니다. </p>
<h3>
<a aria-hidden="true" class="anchor" href="#4-client-to-send-and-receive-messages" id="user-content-4-client-to-send-and-receive-messages"><span class="octicon octicon-link"></span></a>4. Client to send and receive messages</h3>
<p>The client and server communications in several ways:</p>
<ul>
<li>Request - Response</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a request to connector server，params {name: name}</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// callback</span>
  <span class="pl-c">// do something</span>
});</pre></div>
<ul>
<li>Notify</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a notification to server</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<ul>
<li>Push</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// When new players to join, the server will broadcast a message to all players.The client bind through this route, to get the message</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#4-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EC%97%90%EA%B2%8C-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A3%BC%EA%B3%A0-%EB%B0%9B%EA%B8%B0" id="user-content-4-클라이언트에게-메시지-주고-받기"><span class="octicon octicon-link"></span></a>4. 클라이언트에게 메시지 주고 받기</h3>
<p>클라이언트와 서버의 통신은 여러가지 방식이 있습니다:</p>
<ul>
<li>요청(Request) - 응답(Response)</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// connector 서버에 요청 보내기，파라메터 {name: name}</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// callback</span>
  <span class="pl-c">// do something</span>
});</pre></div>
<ul>
<li>공지(Notify)</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// 서버에 공지 보내기</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<ul>
<li>푸쉬(Push)</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// 새로운 플레이어가 접속할 때, 서버는 모든 플레이어에게 메시지를 전파합니다. 클라이언트는 메시지를 얻기 위해 이 경로에 바인드 됩니다.</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#5-leave-the-game" id="user-content-5-leave-the-game"><span class="octicon octicon-link"></span></a>5. Leave the game</h3>
<p>When the player leaves the game, the disconnect message is received by connector server, then it needs to removed the user is in area server, and broadcast a message to other online players.</p>
<p>Every server processes are independent, so it need RPC. Fortunately, do an RPC is so easy in Pomelo framework.</p>
<p>The <code>area</code> server want to provide a series of remote interface for other server process calls only need to create a <code>remote</code> directory in <code>servers/area</code> directory. Interface exposed by the files in this directory can be used as an RPC call interface.</p>
<p>For example, a player leave the game:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// when the session closed, it will emit a event</span>
<span class="pl-smi">session</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>closed<span class="pl-pds">'</span></span>, <span class="pl-smi">onUserLeave</span>.<span class="pl-en">bind</span>(<span class="pl-c1">null</span>, <span class="pl-smi">self</span>.<span class="pl-smi">app</span>));

<span class="pl-k">var</span> <span class="pl-en">onUserLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">app</span>, <span class="pl-smi">session</span>, <span class="pl-smi">reason</span>) {
  <span class="pl-k">if</span> (session <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">session</span>.<span class="pl-smi">uid</span>) {
    <span class="pl-c">// do an rpc</span>
    <span class="pl-smi">app</span>.<span class="pl-smi">rpc</span>.<span class="pl-smi">area</span>.<span class="pl-smi">playerRemote</span>.<span class="pl-en">playerLeave</span>(session, {playerId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>playerId<span class="pl-pds">'</span></span>), areaId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>)}, <span class="pl-c1">null</span>);
  }
};</pre></div>
<p>In server: </p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// area/remote/playerRemote.js</span>
<span class="pl-c1">exports</span>.<span class="pl-en">playerLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">args</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-c">// push message</span>
  <span class="pl-smi">area</span>.<span class="pl-en">getChannel</span>().<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>onUserLeave<span class="pl-pds">'</span></span>, code<span class="pl-k">:</span> <span class="pl-smi">consts</span>.<span class="pl-c1">MESSAGE</span>.<span class="pl-c1">RES</span>, playerId<span class="pl-k">:</span> playerId});
  <span class="pl-c">// ...</span>
};</pre></div>
<p>This easily completed an RPC!</p>
<h3>
<a aria-hidden="true" class="anchor" href="#5-%EA%B2%8C%EC%9E%84-%EB%82%98%EA%B0%80%EA%B8%B0" id="user-content-5-게임-나가기"><span class="octicon octicon-link"></span></a>5. 게임 나가기</h3>
<p>플레이어가 게임에서 나갈 때, connector 서버에 접속 해제 메시지를 받게 되는데, area 서버에서 유저를 제거하고, 다른 접속 중인 플레이어들에게 메시지를 전파하기 위해 필요합니다. </p>
<p>모든 서버 프로세서는 독립적이라 RPC가 필요합니다. 다행히 Pomelo 프레임워크에서 RPC는 굉장히 쉽습니다.</p>
<p><code>area</code>서버는 다른 서버 프로세스 호출 하기 위한 일련의 원거리 인터페이스를 제공하기 위해 <code>servers/area</code> 디렉토리에 <code>remote</code> 디렉토리를 만들기만 하면 됩니다. 이 디렉토리의 파일로 드러난 인터페이스는 RPC call 인터페이스로 사용 될 수 있습니다.</p>
<p>예를들어, 플레이어가 게임에서 나갑니다:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// 세션이 끊어 졌을 때 이벤트를 발생 시킵니다</span>
<span class="pl-smi">session</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>closed<span class="pl-pds">'</span></span>, <span class="pl-smi">onUserLeave</span>.<span class="pl-en">bind</span>(<span class="pl-c1">null</span>, <span class="pl-smi">self</span>.<span class="pl-smi">app</span>));

<span class="pl-k">var</span> <span class="pl-en">onUserLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">app</span>, <span class="pl-smi">session</span>, <span class="pl-smi">reason</span>) {
  <span class="pl-k">if</span> (session <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">session</span>.<span class="pl-smi">uid</span>) {
    <span class="pl-c">// do an rpc</span>
    <span class="pl-smi">app</span>.<span class="pl-smi">rpc</span>.<span class="pl-smi">area</span>.<span class="pl-smi">playerRemote</span>.<span class="pl-en">playerLeave</span>(session, {playerId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>playerId<span class="pl-pds">'</span></span>), areaId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>)}, <span class="pl-c1">null</span>);
  }
};</pre></div>
<p>서버: </p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// area/remote/playerRemote.js</span>
<span class="pl-c1">exports</span>.<span class="pl-en">playerLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">args</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-c">// push message</span>
  <span class="pl-smi">area</span>.<span class="pl-en">getChannel</span>().<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>onUserLeave<span class="pl-pds">'</span></span>, code<span class="pl-k">:</span> <span class="pl-smi">consts</span>.<span class="pl-c1">MESSAGE</span>.<span class="pl-c1">RES</span>, playerId<span class="pl-k">:</span> playerId});
  <span class="pl-c">// ...</span>
};</pre></div>
<p>RPC를 쉽게 완료 합니다!</p>
</div>
</div></body></html>