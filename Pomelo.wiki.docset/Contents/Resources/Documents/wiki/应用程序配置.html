<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>应用程序配置 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:2F42:FB78E49:5670C191" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="4a742e57d9eb9c42c8d4ade66e0e5fcbf89e3667" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<p>在这部分，我们来介绍如何配置框架。我们知道在pomelo中，可以配置各个组件的选项，加载配置文件，开启pomelo的特性等等。这一切配置都是在game-server/app.js中进行的。实际上，在pomelo的应用中有两个app.js,一个在game-server目录下，一个在web-server目录下。其中game-server下的app.js是整个游戏服务器的入口和配置点，而web-server下的app.js则是web服务器入口。在这里，我们仅仅介绍如何在game-server/app.js中配置框架以及pomelo框架使用的服务器配置文件的格式。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#appjs%E6%96%87%E4%BB%B6" id="user-content-appjs文件"><span class="octicon octicon-link"></span></a>app.js文件</h1>
<p>app.js是运行pomelo项目的入口，在app.js中，首先会创建一个app的实例，这个app作为整个框架的配置上下文来使用,用户可以通过这个上下文，设置一些全局变量，加载配置信息等等操作。app.js中的一般代码如下：</p>
<div class="highlight highlight-source-js"><pre>
<span class="pl-k">var</span> pomelo <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>pomelo<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> app <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-en">createApp</span>();

<span class="pl-c">// some configuration</span>

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-k">&lt;</span>env<span class="pl-k">&gt;</span>, <span class="pl-k">&lt;</span>serverType<span class="pl-k">&gt;</span>, <span class="pl-k">function</span>() {

});

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(....);
<span class="pl-smi">app</span>.<span class="pl-en">set</span>(...);
<span class="pl-smi">app</span>.<span class="pl-en">route</span>(...);

<span class="pl-c">// ...</span>

<span class="pl-c">// start app</span>
<span class="pl-smi">app</span>.<span class="pl-c1">start</span>();
</pre></div>
<p>首先会创建一个app实例，然后是一些通过app这个上下文对框架的一些配置以及一些初始化操作，最后启动应用。这里我们将主要关注对框架的配置部分。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E4%BD%BF%E7%94%A8appconfigure%E8%B0%83%E7%94%A8%E6%9D%A5%E9%85%8D%E7%BD%AE" id="user-content-使用appconfigure调用来配置"><span class="octicon octicon-link"></span></a>使用app.configure调用来配置</h1>
<p>服务器的配置主要由configure()方法完成，完整的app.configure配置参数如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>([env], [serverType], [<span class="pl-k">function</span>]);</pre></div>
<p>前两个参数是可选的， 以下是参数说明：</p>
<ul>
<li>env: 运行环境， 可设成development, production或development|production</li>
<li>serverType: 服务器类型，设置了这个参数只会对当前参数类型服务器做初始化，不设置则对所有服务器执行初始化function </li>
<li>function: 具体的初始化操作， 内部可以写任何对框架的配置操作逻辑。</li>
</ul>
<p>以下是一些配置实例：</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E5%AE%9E%E4%BE%8B%E4%B8%80" id="user-content-实例一"><span class="octicon octicon-link"></span></a>实例一</h4>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-k">function</span>(){
    <span class="pl-c">// do some configuration</span>
});</pre></div>
<p>这种配置将对所有模式(development/production)下的所有服务器生效，它等价于在app.js中，不调用configure，直接执行相关的配置，代码示例如下：</p>
<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-k">function</span>() {
    <span class="pl-en">doSomeConfiguration</span>();
  });

<span class="pl-c">// &lt;==&gt;</span>

<span class="pl-en">doSomeConfiguration</span>(); <span class="pl-c">// equivalent to above `app.configure`</span>
</pre></div>
<h4>
<a aria-hidden="true" class="anchor" href="#%E5%AE%9E%E4%BE%8B%E4%BA%8C" id="user-content-实例二"><span class="octicon octicon-link"></span></a>实例二</h4>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
    <span class="pl-c">// do some configuration just for development env only.</span>
});</pre></div>
<p>这种配置则只针对development模式下所有服务器生效，同样在这里可以填入任何配置。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E5%AE%9E%E4%BE%8B%E4%B8%89" id="user-content-实例三"><span class="octicon octicon-link"></span></a>实例三</h4>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
    <span class="pl-c">// do some configuration just for development env and chat server only.</span>
});</pre></div>
<p>这种配置则针对development模式下的chat服务器生效，这里同样可以填入任何配置。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9" id="user-content-配置内容"><span class="octicon octicon-link"></span></a>配置内容</h4>
<p>在configure中用户可以根据应用的不同需求在不同的服务器中进行相关配置，例如在全局设置mysql参数：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
     <span class="pl-smi">app</span>.<span class="pl-en">loadConfig</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql<span class="pl-pds">'</span></span>, <span class="pl-smi">app</span>.<span class="pl-en">getBase</span>() <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>/config/mysql.json<span class="pl-pds">'</span></span>);
});</pre></div>
<p>另外也可以选择在具体的服务器中进行应用的配置，例如可以做一些初始化操作：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">initArea</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(){
   <span class="pl-c">//area init</span>
};
<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>area<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
     <span class="pl-en">initArea</span>();
});
</pre></div>
<p>而更多地，可以在configure中，针对不同的服务器，不同的环境，对框架进行不同的配置。这些配置包括设置一个上下文变量供应用使用，开启一些功能选项，配置加载一个自定义的component，针对不同的服务器，配置filter等等配置操作，如下所示:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>() {
    <span class="pl-smi">app</span>.<span class="pl-en">route</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-smi">routeUtil</span>.<span class="pl-smi">chat</span>);
});

<span class="pl-smi">app</span>.<span class="pl-en">enable</span>(<span class="pl-s"><span class="pl-pds">'</span>systemMonitor<span class="pl-pds">'</span></span>);

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>gate<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>() {
    <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
       connector<span class="pl-k">:</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">connectors</span>.<span class="pl-smi">hybridconnector</span>,
       heartbeat<span class="pl-k">:</span> <span class="pl-c1">3</span>
       });
    }); <span class="pl-c">// configure connector for gate server</span></pre></div>
<p>下面就对这些框架配置作些介绍。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%98%E9%87%8F%E5%AD%98%E5%8F%96" id="user-content-上下文变量存取"><span class="octicon octicon-link"></span></a>上下文变量存取</h1>
<p>上下文对象app提供了设置和获取应用变量的方法，其签名为：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">set</span>(name, value, [isAttach]);
<span class="pl-smi">app</span>.<span class="pl-en">get</span>(name);</pre></div>
<ul>
<li>如上，对于set来说，有三个参数，分别是变量名，变量的值以及一个可选的参数isAttach。如果isAttach设置为true的话，那么表示将变量attach到app对象上，作为app的一个属性，以后对此变量的访问，可以直接通过app.name进行访问，这个参数默认为false。</li>
<li>对于get调用，就是一个很简单的通过变量名获取变量值。</li>
</ul>
<p>示例代码如下:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>server<span class="pl-pds">'</span></span>,server);
<span class="pl-k">var</span> server <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>server<span class="pl-pds">'</span></span>);

<span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>service<span class="pl-pds">'</span></span>, service, <span class="pl-c1">true</span>);
<span class="pl-k">var</span> service <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-smi">service</span>;</pre></div>
<p>在pomelo中框架中，可以通过app.set给pomelo的组件配置相应的选项，也可以通过app.get获得到pomelo框架加载的服务，如backendSessionService，channelService等等，示例代码如下:</p>
<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
  <span class="pl-c">// ...</span>
}); <span class="pl-c">// set opts for connector component</span>

<span class="pl-k">var</span> backendSessionService <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>backendSessionService<span class="pl-pds">'</span></span>); <span class="pl-c">// get backendSessionService instance</span></pre></div>
<p>如果用户需要自己设置一些自己的自定义变量，也可以通过app这个上下文实现获取和设置。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E5%BC%80%E5%90%AF%E5%92%8C%E5%85%B3%E9%97%AD%E5%8A%9F%E8%83%BD%E9%80%89%E9%A1%B9" id="user-content-开启和关闭功能选项"><span class="octicon octicon-link"></span></a>开启和关闭功能选项</h1>
<p>应用的功能选项配置可以通过enable和disable来打开和关闭。另外，用户可以通过enabled和disabled对相应的状态进行判断，如果该状态存在则返回true,反之返回false。例如要打开或者关闭应用的rpc debug log并查看其状态是否存在, 示例代码如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">enable</span>(<span class="pl-s"><span class="pl-pds">'</span>rpcDebugLog<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-en">enabled</span>(<span class="pl-s"><span class="pl-pds">'</span>rpcDebugLog<span class="pl-pds">'</span></span>); <span class="pl-c">// return true</span>
<span class="pl-smi">app</span>.<span class="pl-en">disable</span>(<span class="pl-s"><span class="pl-pds">'</span>rpcDebugLog<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-c1">disabled</span>(<span class="pl-s"><span class="pl-pds">'</span>rpcDebugLog<span class="pl-pds">'</span></span>); <span class="pl-c">//return true</span></pre></div>
<p>在pomelo框架中，当需要做更详细的监控管理的时候，可以打开systemMonitor选项，打开systemMonitor选项会使得默认加载额外的admin-module，示例代码如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">enable</span>(<span class="pl-s"><span class="pl-pds">'</span>systemMonitor<span class="pl-pds">'</span></span>); <span class="pl-c">// enable system monitor</span></pre></div>
<p>同样，用户可以设置自己应用的一些功能选项，并通过enable，disable，enabled，disabled来进行开启关闭以及检查。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" id="user-content-加载配置文件"><span class="octicon octicon-link"></span></a>加载配置文件</h1>
<p>用户可以通过loadConfig加载配置文件，加载后文件中的参数将直接挂载到app对象上。例如需要加载mysql.json文件，示例代码如下：</p>
<div class="highlight highlight-source-json"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>development<span class="pl-pds">"</span></span>:
    {
      <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>3306<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>database<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>pomelo<span class="pl-pds">"</span></span> 
    }
}</pre></div>
<p>然后，加载完成后，就可以直接通过app对象，访问具体的配置参数，示例代码如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">loadConfig</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql<span class="pl-pds">'</span></span>, <span class="pl-smi">path</span>.<span class="pl-en">resolve</span>(<span class="pl-s"><span class="pl-pds">'</span>./config/mysql.json<span class="pl-pds">'</span></span>));
<span class="pl-k">var</span> host <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql<span class="pl-pds">'</span></span>).<span class="pl-c1">host</span>; <span class="pl-c">//返回 127.0.0.1</span></pre></div>
<p>当然，用户可以使用loadConfig的调用加载任何json格式的配置文件，用于其他的目的，并能通过app进行访问。需要注意的是所有的json配置文件中都要指定具体的模式，也就是development或者production。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E5%8A%A0%E8%BD%BDcomponent" id="user-content-加载component"><span class="octicon octicon-link"></span></a>加载component</h1>
<p>pomelo的功能由其component提供，pomelo会默认根据服务器的类型加载不同的内建组件，另外用户可以根据应用需求自定义组件。组件的加载主要是使用load方法，示例代码如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-c1">load</span>(HelloWorldComponent, [opts]); <span class="pl-c">//opts is optional</span></pre></div>
<h1>
<a aria-hidden="true" class="anchor" href="#%E5%8A%A0%E8%BD%BDplugin" id="user-content-加载plugin"><span class="octicon octicon-link"></span></a>加载plugin</h1>
<p>pomelo还可以加载自定义的插件，一个插件由多个component和一组对应用的事件进行响应的事件处理组成，加载插件使用app.use, 示例代码如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// app.use(&lt;plugin&gt;, &lt;plugin options&gt;);</span>

<span class="pl-k">var</span> statusPlugin <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>pomelo-status-plugin<span class="pl-pds">'</span></span>);

<span class="pl-smi">app</span>.<span class="pl-en">use</span>(statusPlugin, {
 status<span class="pl-k">:</span>{
  host<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>,
  port<span class="pl-k">:</span> <span class="pl-c1">6379</span>
 }
});</pre></div>
<h1>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AErouter" id="user-content-配置router"><span class="octicon octicon-link"></span></a>配置router</h1>
<p>router主要负责请求路由信息的维护，路由计算，路由结果缓存等工作，并能根据需要切换路由策略，更新路由信息等。用户可以自定义不同服务器的不同路由规则，然后进行配置即可。以下示例为chat服务器配置路由规则：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">//routeUtil.js</span>
<span class="pl-smi">app</span>.<span class="pl-en">route</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-smi">routeUtil</span>.<span class="pl-smi">chat</span>);</pre></div>
<p>在routerUtil中可以具体的定义不同服务器的路由规则，例如：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">routeUtil</span>.<span class="pl-en">chat</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">session</span>, <span class="pl-smi">msg</span>, <span class="pl-smi">app</span>, <span class="pl-smi">callback</span>) {
    <span class="pl-k">var</span> chatServers <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">getServersByType</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>); 
    <span class="pl-k">if</span> (<span class="pl-k">!</span>chatServers) {
        <span class="pl-en">callback</span>(<span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>can not find chat servers.<span class="pl-pds">'</span></span>));
        <span class="pl-k">return</span>;
    }
    <span class="pl-k">var</span> server <span class="pl-k">=</span> <span class="pl-smi">dispatcher</span>.<span class="pl-en">dispatch</span>(<span class="pl-smi">session</span>.<span class="pl-smi">rid</span>, chatServers);
    <span class="pl-en">callback</span>(<span class="pl-c1">null</span>, <span class="pl-smi">server</span>.<span class="pl-c1">id</span>);
};</pre></div>
<p>在路由函数中，通过最后的回调函数中返回服务器的id即可，这里使用dispatcher对session.rid进行hash处理从而完成服务器选择。用户可以根据自己的实际需求进行配置相应的router。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AEfilter" id="user-content-配置filter"><span class="octicon octicon-link"></span></a>配置filter</h1>
<p>当一个客户端请求到达服务器后，经过filter链和handler处理，最后生成响应返回给客户端。handler是业务逻辑实现的地方，filter则是执行业务前进行预处理和业务处理后清理的地方。为了开发者方便，系统内建提供了一些filter，例如：serialFilter,timeFilter，timeOutFilter，另外用户可以根据应用的需要自定义filter。配置filter的调用示例如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">filter</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">filters</span>.<span class="pl-en">serial</span>()); <span class="pl-c">// use builtin filter: serial filter</span>

<span class="pl-smi">app</span>.<span class="pl-en">filter</span>(FooFilter); <span class="pl-c">// use FooFilter as a before &amp; after filter</span>

<span class="pl-smi">app</span>.<span class="pl-en">before</span>(beforeFilter); <span class="pl-c">// use beforeFilter as a before filter</span>

<span class="pl-smi">app</span>.<span class="pl-en">after</span>(afterFilter); <span class="pl-c">// use afterFilter as an after filter</span></pre></div>
<p>用户可以自定义自己的filter，然后通过app.filter调用，将其配置进框架。如果仅仅是before filter，那么就调用app.before，如果是after filter，就掉用app.after，如果既定义了before filter又定义了after filter，那么就可以使用app.filter调用了。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AEadmin-module" id="user-content-配置admin-module"><span class="octicon octicon-link"></span></a>配置admin-module</h1>
<p>pomelo 提供了监控管理框架，可以给其配置不同的admin module，具体的配置使用调用app.registerAdmin，示例代码如下：</p>
<div class="highlight highlight-source-js"><pre>    <span class="pl-smi">app</span>.<span class="pl-en">registerAdmin</span>(<span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>../modules/watchdog<span class="pl-pds">'</span></span>), {app<span class="pl-k">:</span> app, master<span class="pl-k">:</span> <span class="pl-c1">true</span>});</pre></div>
<p>用户也可以自定义自己的module，然后通过registerAdmin调用，加载到框架。</p>
<h1>
<a aria-hidden="true" class="anchor" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F" id="user-content-服务器配置文件格式"><span class="octicon octicon-link"></span></a>服务器配置文件格式</h1>
<p>pomelo的配置文件都在game-server/config目录下，其中有两个很重要的服务器配置文件servers.json和master.json。
所有的配置文件中，都分为development和production两种配置模式，以对应具体的是开发调试环境还是具体的产品环境，其配置字段如下:</p>
<p>master.json中:</p>
<ul>
<li>id: master 服务器的服务器id，是一个字符串;</li>
<li>host: master 服务器的host，可以是一个ip或域名;</li>
<li>port: master服务器开的端口，默认是3005;</li>
<li>args: 可选的，在这里配置的参数选项，是用来给node/v8使用的，如你可以配置<code>"args": "--debug=5858"</code>,这样的话，就可以开启调试。</li>
</ul>
<p>servers.json中:</p>
<ul>
<li>id: 应用服务器的服务器id，是一个字符串;</li>
<li>host: 应用服务器的host，可以是一个ip或域名;</li>
<li>port: 接受rpc请求时使用的端口号，对于后端服务器来说必须的，对于前端服务器来说，如果仅仅像gate服务器那样，并不维护具体的客户端连接，仅仅给客户端返回可以连接的前端服务器的地址信息的话，port则是可以省略的。一般来说，port不应该省略;</li>
<li>frontend: 是一个boolean值，对于前端服务器，配置为true，如果省略的话，则默认为false。后端服务器不配置;</li>
<li>clientPort: 这是前端服务器接受客户端连接启用的端口，对于后端服务器来说，不需要配置，对于前端服务器，则是必需的。</li>
<li>max-connections: 可选的，用来说明前端服务器最多承受的连接数，如果超过了这个连接数，则后来的连接将会会connector拒绝;</li>
<li>args: 可选的，同master中的语义一样。</li>
</ul>
<h1>
<a aria-hidden="true" class="anchor" href="#%E6%80%BB%E7%BB%93" id="user-content-总结"><span class="octicon octicon-link"></span></a>总结</h1>
<p>在这部分，介绍了在app.js如何配置整个框架并在最后给出了服务器配置文件的格式。通过application的configure等调用，可以给不同的服务器完成不同的配置，比如，配置router，配置filter，为特定类型的服务器加载自定义的component等等。同样，在这里，也可以做一些初始化的加载操作，比如，当应用需要数据库时，可以加载mysql的配置文件，并将配置信息设置到app上下文中，这样在应用中，就可以通过app直接获取到对应的配置信息。</p>
</div>
</div></body></html>