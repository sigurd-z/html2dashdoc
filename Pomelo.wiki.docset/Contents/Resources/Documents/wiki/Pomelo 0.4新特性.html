<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo 0.4新特性 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448C:146B7753:5670C06A" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="fd2053bc3f8a7eaa3a66e156414e523f8054ec40" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#pomelo04%E6%96%B0%E7%89%B9%E6%80%A7" id="user-content-pomelo04新特性"><span class="octicon octicon-link"></span></a>Pomelo0.4新特性</h1>
<p>在0.4版本中，主要对Pomelo内部结构进行了调整，提供更友好的自定义通讯协议支持，以及自定义的数据发送包调度策略，为各种应用场景提供更灵活的支持。</p>
<h2>
<a aria-hidden="true" class="anchor" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE" id="user-content-自定义协议"><span class="octicon octicon-link"></span></a>自定义协议</h2>
<h3>
<a aria-hidden="true" class="anchor" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%AE%9E%E7%8E%B0" id="user-content-服务器端实现"><span class="octicon octicon-link"></span></a>服务器端实现</h3>
<p>根据网友的建议，Pomelo框架对协议模块做了更细致的划分，以支持更灵活的定制特性。主要结构如下图所示：</p>
<img alt="pomelo-transport" data-canonical-src="http://pomelo.netease.com/resource/documentImage/pomelo-transport.png" src="https://camo.githubusercontent.com/754e018b700d7303646ba1e1d2ae703203babbaf/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f706f6d656c6f2d7472616e73706f72742e706e67">
<p>在上层模块和底层的transport模块之间加入protocol层对协议数据包进行编解码。Protocol层主要针对上层通讯数据进行编解码，并与具体的connector实现相关联。对于<code>hybridconnector</code>，编解码的层次对应于Message层的协议数据。对于<code>sioconnector</code>，编解码的层次则对应于socket.io协议之上的数据。</p>
<p>Protocol层的编解码算法可以通过向<code>connector</code>组件传递encode/decode初始化参数来定制。具体例子如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">encode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">reqId</span>, <span class="pl-smi">route</span>, <span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized encode with reqId, route and msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return encode result</span>
};

<span class="pl-k">var</span> <span class="pl-en">decode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized decode with msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return decode result</span>
};

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>production|development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>connector<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
    connector <span class="pl-k">:</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">connectors</span>.<span class="pl-smi">hybridconnector</span>,
    encode<span class="pl-k">:</span> encode,
    decode<span class="pl-k">:</span> decode
  });
});</pre></div>
<p>每当connector上有数据包需要编解码即会触发对应的encode/decode函数。</p>
<ul>
<li><p><code>encode(reqId, route, msg)</code> - 负责将<code>reqId</code>, <code>route</code>和<code>msg</code>进行编码。可以通过<code>reqId</code>对判断协议包的类型，如果<code>reqId &gt; 0</code>，表示是request消息，如果<code>reqId === 0</code>，表示是push消息。返回值即编码结果，将直接投递给底层传输模块发送出去。</p></li>
<li><p><code>decode(msg)</code> - 负责将底层获取到的数据包解码成上层的消息。<code>msg</code>为底层传输模块获取到的数据，与客户端相同层次所传输的数据一致。返回结果为解码后的结果，是上层框架所能处理的消息，格式为：{id: id, route: route, body: body}。其中id为消息的id，request类型的消息id为正整数，notify消息可以没有id字段。route为String类型，消息的route字段；body为Object类型，即消息体。</p></li>
</ul>
<p>可以通过 <code>pomelo.connectors.hybridconnector.encode/decode</code> 和 <code>pomelo.connectors.sioconnector.encode/decode</code> 获取对应connector的默认编解码方法。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#js%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0" id="user-content-js客户端实现"><span class="octicon octicon-link"></span></a>JS客户端实现</h3>
<p>与服务器端类似，Pomelo客户端也提供了相应的定制参数，具体例子如下：</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">encode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">reqId</span>, <span class="pl-smi">route</span>, <span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized encode with reqId, route and msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return encode result</span>
};

<span class="pl-k">var</span> <span class="pl-en">decode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized decode with msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return decode result</span>
};

<span class="pl-smi">pomelo</span>.<span class="pl-en">init</span>({
  host<span class="pl-k">:</span> host, 
  port<span class="pl-k">:</span> port, 
  log<span class="pl-k">:</span> <span class="pl-c1">true</span>, 
  encode<span class="pl-k">:</span> encode, 
  decode<span class="pl-k">:</span> decode}, <span class="pl-k">function</span>() {
});</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E5%8F%91%E9%80%81%E7%9A%84%E8%B0%83%E5%BA%A6" id="user-content-数据包发送的调度"><span class="octicon octicon-link"></span></a>数据包发送的调度</h2>
<p>从上面的图可以看到，消息经过protocol层编码后，还需要经过一个scheduler层才能到达最下面的transport层。</p>
<p>scheduler层负责决定消息发送的调度策略，比如：消息的发送优先级，广播时的分批发送等。</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">SchedulerService</span> <span class="pl-k">=</span> <span class="pl-k">function</span>() {
};

<span class="pl-c1">SchedulerService</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">schedule</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">route</span>, <span class="pl-smi">msg</span>, <span class="pl-smi">recvs</span>, <span class="pl-smi">opts</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-c">// do the schedule</span>
};

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>production|development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>connector<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>schedulerConfig<span class="pl-pds">'</span></span>, {
    scheduler<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">SchedulerService</span>()
  });
});</pre></div>
<p>schedule(route, msg, recvs, opts, cb)负责实现具体的调度逻辑。在schedule函数内部可以调用<code>sessionService.sendMessage</code>将消息发送出去。</p>
<ul>
<li>route - 消息的route字符串，response消息route参数为空。</li>
<li>msg - 编码后的消息内容。</li>
<li>recvs - 接收者的session id列表。</li>
<li>opts - 附加参数。opts.isBroadcast表示当前消息是否是广播，opts.isResponse表示当前消息是否是response，opts.isPush表示当前消息是push消息。</li>
</ul>
<p>Pomelo框架默认提供两类scheduler。</p>
<ul>
<li>
<code>pomelo.schedulers.direct</code> - 默认采用的scheduler，直接将上层下来的消息发送出去。</li>
<li>
<code>pomelo.schedulers.buffer</code> - 对上层的消息进行缓存，并定期批量发送出去。可以通过<code>flushInterval</code>初始化参数设置刷新间隔，单位为毫秒，默认值为20毫秒。</li>
</ul>
<h2>
<a aria-hidden="true" class="anchor" href="#%E6%94%AF%E6%8C%81%E5%90%8C%E4%B8%80%E8%B4%A6%E5%8F%B7%E5%A4%9A%E5%A4%84%E7%99%BB%E5%BD%95" id="user-content-支持同一账号多处登录"><span class="octicon octicon-link"></span></a>支持同一账号多处登录</h2>
<p>0.4版本之前同一个账号在同一个前端服务器中只能存在一个session。0.4之后支持同一个账号多地登录，以支持在web应用中多个页面登录应用的情景。</p>
<p>该特性会影响到下列接口：</p>
<ul>
<li>
<code>localSessionService.getByUid</code> - 语义改为获取指定uid下所有的session信息，返回的session改为session数组。</li>
<li>
<code>localSessionService.kickByUid</code> - 语义改为踢对应uid所有的session下线。</li>
</ul>
<p>以及<code>sessionServie</code>中的对应私有方法：</p>
<ul>
<li>
<code>sessionService.getByUid</code> - 语义改为获取指定uid下所有的session信息，返回的session改为session数组。</li>
<li>
<code>sessionService.kickByUid</code> - 语义改为踢对应uid所有的session下线。</li>
</ul>
<h2>
<a aria-hidden="true" class="anchor" href="#hybridconnector%E6%B7%BB%E5%8A%A0%E5%BF%83%E8%B7%B3%E8%B6%85%E6%97%B6%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9" id="user-content-hybridconnector添加心跳超时断开连接选项"><span class="octicon octicon-link"></span></a>HybridConnector添加心跳超时断开连接选项</h2>
<p>0.3版本中，<code>hybridconnector</code>服务器端检测到心跳超时不会主动断开连接。在0.4.2版本中，添加<code>disconnectOnTimeout</code>选项，当服务器检测到心跳超时后会主动断开该客户端连接。使用的例子如下：</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
    connector <span class="pl-k">:</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">connectors</span>.<span class="pl-smi">hybridconnector</span>,
    heartbeat <span class="pl-k">:</span> <span class="pl-c1">3</span>,
    disconnectOnTimeout<span class="pl-k">:</span> <span class="pl-c1">true</span>
  });   </pre></div>
</img></div>
</div></body></html>