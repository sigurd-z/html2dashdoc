<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Treasures introduction · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="7250A4CA:691F:5FE2D3C:5670C150" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="3564a8fe9114bced6003f283bf15ef89562a0025" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#treasures-introduction" id="user-content-treasures-introduction"><span class="octicon octicon-link"></span></a>Treasures Introduction</h1>
<h2>
<a aria-hidden="true" class="anchor" href="#description" id="user-content-description"><span class="octicon octicon-link"></span></a>Description</h2>
<p><a href="https://github.com/NetEase/treasures">Treasures</a> game which extracted from the game <a href="https://github.com/NetEase/lordofpomelo">LordOfPomelo</a> and remove a lot of game logic, in order to show the working principle and usage of the <a href="https://github.com/NetEase/pomelo">Pomelo</a> framework more clearly.</p>
<p>Treasures is very simple, just enter a name, a game character will be randomly generated, and then enter the game scene. Some treasures scattered ground in the game scene , each treasure have score, the player operate the game characters to pick up the treasures, and then will be able to get the scores.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#install-and-run" id="user-content-install-and-run"><span class="octicon octicon-link"></span></a>Install and Run</h2>
<p>Install <code>pomelo</code> with <code>npm</code></p>
<div class="highlight highlight-source-shell"><pre>npm install -g pomelo</pre></div>
<p>Get the source code</p>
<div class="highlight highlight-source-shell"><pre>git clone git://github.com/NetEase/treasures.git</pre></div>
<p>Install the dependencies (enter the project directory first)</p>
<div class="highlight highlight-source-shell"><pre>sh npm-install.sh</pre></div>
<p>Start the <code>web-server</code>  (enter the <code>web-server</code> directory first)</p>
<div class="highlight highlight-source-shell"><pre>node app.js</pre></div>
<p>Start the <code>game-server</code> (enter the <code>game-server</code> directory first)</p>
<div class="highlight highlight-source-shell"><pre>pomelo start</pre></div>
<p>visit <a href="http://localhost:3001">http://localhost:3001</a> in your modern browser(the latest chrome is best), and enter the game.</p>
<p>You can get more details with Pomelo's <a href="https://github.com/NetEase/pomelo/wiki/Quick-start-guide">quick start guide</a></p>
<p>And another <a href="https://github.com/NetEase/pomelo/wiki/Distributed%20Chat">tutorial</a> for study.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#architecture" id="user-content-architecture"><span class="octicon octicon-link"></span></a>Architecture</h2>
<p>Treasures  has 2 parts which are <code>web-Server</code> and <code>game-Server</code>.</p>
<ul>
<li><p><code>web-server</code> is a simple http server, based on Express</p></li>
<li><p><code>game-server</code> is a webSocket server for running the game logic</p></li>
</ul>
<p>Let's have a look at the architecture of the <code>game-server</code> from the config file <code>game-server/config/servers.json</code></p>
<div class="highlight highlight-source-js"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>development<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>connector<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>connector-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3150</span>, <span class="pl-s"><span class="pl-pds">"</span>clientPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3010</span>, <span class="pl-s"><span class="pl-pds">"</span>frontend<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>},
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>connector-server-2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3151</span>, <span class="pl-s"><span class="pl-pds">"</span>clientPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3011</span>, <span class="pl-s"><span class="pl-pds">"</span>frontend<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>}
    ],
    <span class="pl-s"><span class="pl-pds">"</span>area<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>area-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3250</span>, <span class="pl-s"><span class="pl-pds">"</span>areaId<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span>}
    ],
    <span class="pl-s"><span class="pl-pds">"</span>gate<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      {<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>gate-server-1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>clientPort<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3014</span>, <span class="pl-s"><span class="pl-pds">"</span>frontend<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>}
    ]
  }
}</pre></div>
<p>It can be seen that the server side is constituted by the following components:</p>
<ul>
<li>2 <code>connector</code> servers, for receiving and sending messages.</li>
<li>A <code>gate</code> server is mainly used for load balancing which dispatch the connections to the <code>connector</code> servers.</li>
<li>An <code>area</code> server used to drive the game scene, and the game logic.</li>
</ul>
<p>The relationship between the servers, as the following diagram:</p>
<p><img alt="treasure-arch" data-canonical-src="http://pomelo.netease.com/resource/documentImage/treasure-arch.png" src="https://camo.githubusercontent.com/c2fb2d78ea8b90ed2ee5fea5a3e7670a1e8b7f2f/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f74726561737572652d617263682e706e67"/></p>
<h2>
<a aria-hidden="true" class="anchor" href="#source-code-analysis" id="user-content-source-code-analysis"><span class="octicon octicon-link"></span></a>Source code analysis</h2>
<p>We'll analyze the code through the flow of the game.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#1-connect-to-the-server" id="user-content-1-connect-to-the-server"><span class="octicon octicon-link"></span></a>1. Connect to the server</h3>
<p>client: <code>web-server/public/js/main.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>gate.gateHandler.queryEntry<span class="pl-pds">'</span></span>, {uid<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">//...</span>
});</pre></div>
<p>server: <code>game-server/app/servers/gate/handler/gateHandler.js</code></p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">Handler</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">queryEntry</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// return the host and port of the connector server</span>
  <span class="pl-en">next</span>(<span class="pl-c1">null</span>, {code<span class="pl-k">:</span> <span class="pl-smi">Code</span>.<span class="pl-c1">OK</span>, host<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-c1">host</span>, port<span class="pl-k">:</span> <span class="pl-smi">res</span>.<span class="pl-smi">wsPort</span>});
};</pre></div>
<p>So that the client will be able to connect to the <code>connector</code> server</p>
<h3>
<a aria-hidden="true" class="anchor" href="#2-enter-the-game" id="user-content-2-enter-the-game"><span class="octicon octicon-link"></span></a>2. Enter the Game</h3>
<p>After establishing a connection with the <code>connector</code> server, we begin to enter the game.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>When the client sends a request to the <code>connector</code> server for the first time, the server will initialize a <code>session</code> bind with some events.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// session bind with playerId</span>
<span class="pl-smi">session</span>.<span class="pl-en">bind</span>(playerId);
<span class="pl-c">// set player's areaId</span>
<span class="pl-smi">session</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>);</pre></div>
<p>The client send a request to the server for entering game scene</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">"</span>area.playerHandler.enterScene<span class="pl-pds">"</span></span>, {name<span class="pl-k">:</span> name, playerId<span class="pl-k">:</span> <span class="pl-smi">data</span>.<span class="pl-smi">playerId</span>}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>After the client sends a request to the server, the request will reach the <code>connector</code> server at first, and the <code>connector</code> server route the request to the appropriate server <code>area</code> (There is only one <code>area</code> server in this example) according to the route rules(<code>game-server/app/util/routeUtil.js</code>). And then <code>playerHandler</code> in <code>area</code> server will handle the corresponding request, which will add players to the game scene.</p>
<p>After a player is added to the game scene, the other players must be able to see the player to join in real time, so the server must broadcast the message to all players in this game scene.</p>
<p>Create a channel, all players in this game scene will be added to the channel.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// get the channel. If no channel exists, create one.</span>
channel <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>channelService<span class="pl-pds">'</span></span>).<span class="pl-en">getChannel</span>(<span class="pl-s"><span class="pl-pds">'</span>area_<span class="pl-pds">'</span></span> <span class="pl-k">+</span> id, <span class="pl-c1">true</span>);
<span class="pl-c">// add the player to channel</span>
<span class="pl-smi">channel</span>.<span class="pl-c1">add</span>(<span class="pl-smi">e</span>.<span class="pl-c1">id</span>, <span class="pl-smi">e</span>.<span class="pl-smi">serverId</span>);</pre></div>
<p>When someone joins or state changes, these messages will be pushed to each player in this area. 
For example, a player join the area:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">channel</span>.<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, entities<span class="pl-k">:</span> added});</pre></div>
<p>These messages are sent to the client through the <code>connector</code> server. And the <code>area</code> determine which <code>connector</code> server sent out by <code>session.frontendId</code>.</p>
<p>The client accept messages:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// When new players to join, the server will broadcast a message to all players. The client bind through this route, to get the message </span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#3-area-server" id="user-content-3-area-server"><span class="octicon octicon-link"></span></a>3. Area Server</h3>
<p>Are server is a tick-driven game scenes. Each tick will update the status of the entity in the scene, and if the state has changed, these changes will be pushed to the client.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">function</span> <span class="pl-en">tick</span>() {
  <span class="pl-c">//run all the action</span>
  <span class="pl-smi">area</span>.<span class="pl-en">actionManager</span>().<span class="pl-en">update</span>();
  <span class="pl-c">// update entities</span>
  <span class="pl-smi">area</span>.<span class="pl-en">entityUpdate</span>();
  <span class="pl-c">// update rank</span>
  <span class="pl-smi">area</span>.<span class="pl-en">rankUpdate</span>();
}</pre></div>
<p>A player do a <code>move</code> action
client:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a `move` request to server</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<p>server:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// in playerHandler</span>
<span class="pl-c1">handler</span>.<span class="pl-en">move</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// create a move action</span>
  <span class="pl-k">var</span> action <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Move</span>({
    entity<span class="pl-k">:</span> player,
    endPos<span class="pl-k">:</span> endPos,
  });
});</pre></div>
<p>And this <code>action</code> will update in next <code>tick</code>.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#4-client-send-and-receive-messages" id="user-content-4-client-send-and-receive-messages"><span class="octicon octicon-link"></span></a>4. Client send and receive messages</h3>
<p>The client and server communications in several ways:</p>
<ul>
<li>Request - Response</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a request to connector server，params {name: name}</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {name<span class="pl-k">:</span> name}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// callback</span>
  <span class="pl-c">// do something</span>
});</pre></div>
<ul>
<li>Notify</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// send a notification to server</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">notify</span>(<span class="pl-s"><span class="pl-pds">'</span>area.playerHandler.move<span class="pl-pds">'</span></span>, {targetPos<span class="pl-k">:</span> {x<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">x</span>, y<span class="pl-k">:</span> <span class="pl-smi">entity</span>.<span class="pl-c1">y</span>}, target<span class="pl-k">:</span> targetId});</pre></div>
<ul>
<li>Push</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// When new players to join, the server will broadcast a message to all players.The client bind through this route, to get the message</span>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>addEntities<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#5-leave-the-game" id="user-content-5-leave-the-game"><span class="octicon octicon-link"></span></a>5. Leave the game</h3>
<p>When the player leaves the game, the disconnect message is received by connector server, then it needs to removed the user is in area server, and broadcast a message to other online players.</p>
<p>Every server processes are independent, so it need RPC. Fortunately,  RPC is so easy in Pomelo framework.</p>
<p>The <code>area</code> server want to provide a series of remote interface for other server process calls only need to create a <code>remote</code> directory in <code>servers/area</code> directory. Interface exposed by the files in this directory can be used as an RPC call interface.</p>
<p>For example, a player leave the game:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// when the session closed, it will emit a event</span>
<span class="pl-smi">session</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>closed<span class="pl-pds">'</span></span>, <span class="pl-smi">onUserLeave</span>.<span class="pl-en">bind</span>(<span class="pl-c1">null</span>, <span class="pl-smi">self</span>.<span class="pl-smi">app</span>));

<span class="pl-k">var</span> <span class="pl-en">onUserLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">app</span>, <span class="pl-smi">session</span>, <span class="pl-smi">reason</span>) {
  <span class="pl-k">if</span> (session <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">session</span>.<span class="pl-smi">uid</span>) {
    <span class="pl-c">// do an rpc</span>
    <span class="pl-smi">app</span>.<span class="pl-smi">rpc</span>.<span class="pl-smi">area</span>.<span class="pl-smi">playerRemote</span>.<span class="pl-en">playerLeave</span>(session, {playerId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>playerId<span class="pl-pds">'</span></span>), areaId<span class="pl-k">:</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>areaId<span class="pl-pds">'</span></span>)}, <span class="pl-c1">null</span>);
  }
};</pre></div>
<p>In server: </p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// area/remote/playerRemote.js</span>
<span class="pl-c1">exports</span>.<span class="pl-en">playerLeave</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">args</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-c">// push message</span>
  <span class="pl-smi">area</span>.<span class="pl-en">getChannel</span>().<span class="pl-en">pushMessage</span>({route<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>onUserLeave<span class="pl-pds">'</span></span>, code<span class="pl-k">:</span> <span class="pl-smi">consts</span>.<span class="pl-c1">MESSAGE</span>.<span class="pl-c1">RES</span>, playerId<span class="pl-k">:</span> playerId});
  <span class="pl-c">// ...</span>
};</pre></div>
<p>This easily completed an RPC!</p>
<h3>
<a aria-hidden="true" class="anchor" href="#6-summary" id="user-content-6-summary"><span class="octicon octicon-link"></span></a>6. Summary</h3>
<p>Through the above analysis of the source code which is related to the game process, we have more in-depthly understood of the code structure of the Treasures. This process has basically covers some methods which are related to the use of Pomelo framework to develop game client and server. If you want to understand the content of this respect further, please refer to <a href="https://github.com/NetEase/pomelo/wiki/LordOfPomelo-introduction">LordOfPomelo-introduction</a>.</p>
</div>
</div></body></html>