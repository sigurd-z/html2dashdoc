<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Getting source code &amp; installation · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:2F43:126BBEF1:5670C012" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="71e06edb3c5ce5383333dc48b38097571f45889d" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<p>In this tutorial, we'll implement a simple distributed chat application.</p>
<p>In this section, we will directly obtain the source code from github, and then make it run. Of course, you can use <code>pomelo init</code> to get a project template and then fill the code into the template. </p>
<h1>
<a aria-hidden="true" class="anchor" href="#source-code-structure" id="user-content-source-code-structure"><span class="octicon octicon-link"></span></a>Source Code Structure</h1>
<p>The source code of the distributed chat application is on github, using the following commands to clone:</p>
<pre><code>$ git clone https://github.com/NetEase/chatofpomelo-websocket.git
$ cd chatofpomelo-websocket/
$ git checkout tutorial-starter
</code></pre>
<p>This is a very simple application, and its source code structure is shown below:</p>
<p><img alt="Source Structure" src="src/77fdaf7a6db14548eb36fa9b75b8fd05.png"/></p>
<h4>
<a aria-hidden="true" class="anchor" href="#game-server" id="user-content-game-server"><span class="octicon octicon-link"></span></a>game-server</h4>
<p>All the game business logic code is in <code>game-server</code> directory, and the file app.js is the entrance of the server. It can be seen from the figure above that there are three subdirectories in servers directory: gate, connector and chat. As pomelo uses the file path to distinguish the type of servers, so these three directories represent three different types of servers, we can define handlers, remotes for each type of servers and the defined handlers and remotes to determine the behavior of the server.</p>
<ul>
<li><p>gate server, its logic code is in gateHandler.js and it accepts the request from clients and return a certain address (host, port) of a connector server which can be connected by clients;</p></li>
<li><p>connector server, its logic code is in entryHandler.js and it is mainly to accept the client's requests and route them to chat server, maintain the connections with clients;</p></li>
<li><p>chat server, it has both handler and remote definitions and the handler is to handle request <code>send</code> while the remote runs as a remote service for connector's RPC invocation.</p></li>
</ul>
<p>The config subdirectory in the game-server directory is used to contain  the configuration files for the application, including logs configuration information, master server and other application servers configuration information. You can also place other configuration in this directory, such as database configuration information and so on.</p>
<p>The logs subdirectory in game-server contains all running logs.</p>
<h4>
<a aria-hidden="true" class="anchor" href="#web-server" id="user-content-web-server"><span class="octicon octicon-link"></span></a>web-server</h4>
<p>As the client platform for this chat application is web, so it requires a web server. We will pay more attention on server-side logic and functionalities in this tutorial, for the client, we almost do not need to modify its code, the default works well.</p>
<h1>
<a aria-hidden="true" class="anchor" href="#installation-and-launching" id="user-content-installation-and-launching"><span class="octicon octicon-link"></span></a>Installation and Launching</h1>
<p>First, make sure you have successfully installed pomelo, and run the following command to install dependencies :</p>
<pre><code>$ sh npm-install.sh
</code></pre>
<p>Start the game server:</p>
<pre><code>$ cd game-server
$ pomelo start
</code></pre>
<p>Start the web server :</p>
<pre><code>$ cd web-server
$ node app.js
</code></pre>
<p>If all work well, then we can try our chat service. Go to <code>http://127.0.0.1:3001/index.html</code> and enter a username and a room name to join in the chat. You can launch more than one chat client instance to test the chat application, the effect is as follows:</p>
<p><img alt="chat" src="src/dfc5e1ad7774fae13cfa9c6f2b73c055.png"/></p>
<h1>
<a aria-hidden="true" class="anchor" href="#chat-application-analysis" id="user-content-chat-application-analysis"><span class="octicon octicon-link"></span></a>Chat Application Analysis</h1>
<p>Running architecture of the chat application is shown below:</p>
<p><img alt="multi chat" src="src/1cbb2b7f4d62185ed2b05849eb7700fd.png"/></p>
<p>In this architecture, the front-end server namely connector is responsible for accepting connection from clients and the backend server namely chat server will execute the business logic.</p>
<p>This architecture has the following advantages:</p>
<ul>
<li><p>Load separation: The architecture totally separate the connection code from the business logic code, and it is necessary especially in broadcast-intensive applications(such as games and chat). Intensive broadcast and network communications will consume lots of resource, and after separating, the processing ability of business logic will not be impacted by broadcasting.</p></li>
<li><p>Simplify channel switch: Users can switch channels or rooms without reconnecting because of the separated architecture.</p></li>
<li><p>Better Scalability : We can launch more connector server to deal with the increasing of users.</p></li>
</ul>
<h4>
<a aria-hidden="true" class="anchor" href="#client" id="user-content-client"><span class="octicon octicon-link"></span></a>Client</h4>
<p>The logic in client side includes:</p>
<ul>
<li>Entering a chat room: connecting to server with username and room;</li>
<li>Speaking in a chat room: sending a speaking request to server;</li>
<li>Responding to speaking of other users in the same room: displaying the content of the speaking.</li>
<li>Exiting: disconnecting from server and cleaning up.</li>
</ul>
<p>First, client will query an available connector server address (host, addr) from gate server, and gate server will handle it. The detailed code is in web-server/public/js/client.js, and here just a sample code:</p>
<div class="highlight highlight-source-js"><pre>fuction <span class="pl-en">queryEntry</span>(<span class="pl-smi">uid</span>, <span class="pl-smi">callback</span>) {
  <span class="pl-k">var</span> route <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>gate.gateHandler.queryEntry<span class="pl-pds">'</span></span>;
  <span class="pl-c">// ...</span>
}

$(<span class="pl-s"><span class="pl-pds">"</span>#login<span class="pl-pds">"</span></span>).<span class="pl-c1">click</span>(<span class="pl-k">function</span>() {
  username <span class="pl-k">=</span> $(<span class="pl-s"><span class="pl-pds">"</span>#loginUser<span class="pl-pds">"</span></span>).<span class="pl-en">attr</span>(<span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>);
  rid <span class="pl-k">=</span> $(<span class="pl-s"><span class="pl-pds">'</span>#channelList<span class="pl-pds">'</span></span>).<span class="pl-en">val</span>();

  <span class="pl-c">// ...</span>

  <span class="pl-c">// query entry of connection</span>
  <span class="pl-en">queryEntry</span>(username, <span class="pl-k">function</span>(<span class="pl-smi">host</span>, <span class="pl-smi">port</span>) {
    <span class="pl-smi">pomelo</span>.<span class="pl-en">init</span>({
      host<span class="pl-k">:</span> host,
      port<span class="pl-k">:</span> port,
      log<span class="pl-k">:</span> <span class="pl-c1">true</span>
    }, <span class="pl-k">function</span>() {
         <span class="pl-c">// ...</span>
    });
  }) ;
});
</pre></div>
<p>After querying connector address (host, port), it will login to connector server by sending a request with the username and room id, as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.enter<span class="pl-pds">'</span></span>,
               {username<span class="pl-k">:</span> username, rid<span class="pl-k">:</span> rid}, 
               <span class="pl-k">function</span>() {
    <span class="pl-c">// ...</span>
});
</pre></div>
<p>When speaking, it will request service <code>chat.chatHandler.send</code>, as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>chat.chatHandler.send<span class="pl-pds">'</span></span>,
               {content<span class="pl-k">:</span> msg, from<span class="pl-k">:</span> username, target<span class="pl-k">:</span> <span class="pl-smi">msg</span>.<span class="pl-c1">target</span>},
               <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});</pre></div>
<p>If someone in the same room leaving, joining or speaking, it will receive these action information pushed by server side. In client side, it uses a callback way, as follows:</p>
<div class="highlight highlight-source-js"><pre>
<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span> (<span class="pl-s"><span class="pl-pds">'</span>onAdd<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});

<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span> (<span class="pl-s"><span class="pl-pds">'</span>onLeave<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});

<span class="pl-smi">pomelo</span>.<span class="pl-en">on</span> (<span class="pl-s"><span class="pl-pds">'</span>onChat<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
  <span class="pl-c">// ...</span>
});
</pre></div>
<p>The detailed client code is in web-server/public/js/client.js, and it uses <a href="https://github.com/component/component">component</a> to manage the javascript code in client side.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#server" id="user-content-server"><span class="octicon octicon-link"></span></a>Server</h3>
<p>As we know, in pomelo, as long as the definition of handler and remote for a server is determined, then behavior of the server is determined. In this example, there are three type servers: gate, connector, chat, and the logic they do are as follows :</p>
<ul>
<li>Gate server handles the request from client to query an available connector address. Here, we just configure only one connector server for simplication, so just return the connector's address, the code is in  game-server/app/servers/gate/handler/gateHandler.js, as follows: </li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">handler</span>.<span class="pl-en">queryEntry</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-k">var</span> uid <span class="pl-k">=</span> <span class="pl-smi">msg</span>.<span class="pl-smi">uid</span>;
  <span class="pl-c">// ...</span>
};</pre></div>
<ul>
<li>Connector server accepts and manages connections from clients and maintains the sessions. Its business logic code is in game-server/app/servers/connector/handler/entryHandler.js, as follows:</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">handler</span>.<span class="pl-en">enter</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-k">var</span> self <span class="pl-k">=</span> <span class="pl-v">this</span>;
  <span class="pl-k">var</span> rid <span class="pl-k">=</span> <span class="pl-smi">msg</span>.<span class="pl-smi">rid</span>;
  <span class="pl-k">var</span> uid <span class="pl-k">=</span> <span class="pl-smi">msg</span>.<span class="pl-smi">username</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span> <span class="pl-k">+</span> rid
  <span class="pl-k">var</span> sessionService <span class="pl-k">=</span> <span class="pl-smi">self</span>.<span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>sessionService<span class="pl-pds">'</span></span>);
  <span class="pl-c">// .....</span>
};</pre></div>
<ul>
<li>Chat server handles chatting request and maintains channel information. A chat room can be treated as a channel and  there are multiple users in a channel. When a user initiates a speaking, chat server will broadcast it to the users in the same channel. Chat server also provides remote service for connector server to handle user joining and leaving, so chat server has not only handler definition, but also remote definition too, as follows:</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// chatHandler.js</span>
<span class="pl-c1">handler</span>.<span class="pl-en">send</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>, <span class="pl-smi">session</span>, <span class="pl-smi">next</span>) {
  <span class="pl-k">var</span> rid <span class="pl-k">=</span> <span class="pl-smi">session</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>rid<span class="pl-pds">'</span></span>);
  <span class="pl-k">var</span> username <span class="pl-k">=</span> <span class="pl-smi">session</span>.<span class="pl-smi">uid</span>.<span class="pl-c1">split</span>(<span class="pl-s"><span class="pl-pds">'</span>*<span class="pl-pds">'</span></span>) [<span class="pl-c1">0</span>];
  <span class="pl-c">// .....</span>
};

<span class="pl-c">// chatRemote.js</span>
<span class="pl-c1">chatRemote</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">add</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">uid</span>, <span class="pl-smi">sid</span>, <span class="pl-smi">name</span>, <span class="pl-smi">flag</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-k">var</span> channel <span class="pl-k">=</span> <span class="pl-smi">this</span>.<span class="pl-smi">channelService</span>.<span class="pl-en">getChannel</span>(name, flag);
};

<span class="pl-c1">chatRemote</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">kick</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">uid</span>, <span class="pl-smi">sid</span>, <span class="pl-smi">name</span>) {
  <span class="pl-k">var</span> channel <span class="pl-k">=</span> <span class="pl-smi">this</span>.<span class="pl-smi">channelService</span>.<span class="pl-en">getChannel</span>(name, <span class="pl-c1">false</span>);
  <span class="pl-c">// ...</span>
};</pre></div>
<p>All the configuration information is in game-server/config directory. Here, we only concern on servers.json, master.json. master.js is used to configure the master server, including host and port, while servers.json is used to configure the application servers.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#ios-development" id="user-content-ios-development"><span class="octicon octicon-link"></span></a>iOS development</h3>
<p>For iOS development, you need to use the chatofpomelo without the websocket:</p>
<pre><code>$ git clone https://github.com/NetEase/chatofpomelo.git
</code></pre>
<p>and this client will work with this server. It won't work with the chatofpomelo-websocket server.</p>
<pre><code>$ git clone https://github.com/NetEase/chatofpomelo.git
</code></pre>
<h1>
<a aria-hidden="true" class="anchor" href="#summary" id="user-content-summary"><span class="octicon octicon-link"></span></a>Summary</h1>
<p>In this section, we obtain a simple chat application and make it run, and briefly analyze its source code. To keep simple, we only configure one server for each server type. </p>
<p><a href="Server-scalability" title="multiple servers">Next, we will configure multiple servers for each server type</a> in order to demonstrate how to scale the application based on pomelo out.</p>
</div>
</div></body></html>