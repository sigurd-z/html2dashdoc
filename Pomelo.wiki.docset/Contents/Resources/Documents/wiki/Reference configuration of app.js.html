<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Reference configuration of app.js · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448B:13CA1093:5670C122" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="3d4d2769d36d9189b2247ef50b7874fd255f8689" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<p>A project created by pomelo exists two app.js files, one is in game-server directory and the other is in web-server directory.They correspond to the game server and the web server respectively, and each of them is  the start entry of their own server. The following app.js configuration reference is only for the game server.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#entrance-of-application-setting" id="user-content-entrance-of-application-setting"><span class="octicon octicon-link"></span></a>Entrance of Application Setting</h2>
<p>The app.js is the entrance of pomelo project. When using the pomelo command line to create a new project, a default app.js file will be generated according to the basic project information. The main content is as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> pomelo <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>pomelo<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> app <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-en">createApp</span>();

<span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>nameofproject<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-en">defaultConfiguration</span>();

<span class="pl-smi">app</span>.<span class="pl-c1">start</span>();</pre></div>
<p>Firstly, it creates an application using pomelo; then it sets the application name. After that it makes default configuration of pomelo. These configurations are necessary conditions to create a pomelo project, and finally you can start the application.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#variable-and-property-setting" id="user-content-variable-and-property-setting"><span class="octicon octicon-link"></span></a>Variable and Property Setting</h2>
<p>Application variables can be accessed through set and get methods. For example, to access the server object, the specific code is as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>server<span class="pl-pds">'</span></span>,server);
<span class="pl-k">var</span> server <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>server<span class="pl-pds">'</span></span>);</pre></div>
<p>Application state information can be opened and closed by enable and disable methods. Furthermore, developers can call enabled and disabled methods to check enabled or disabled. For example, you want to open or close application's filter and check its state, and the specific code is as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">enable</span>(<span class="pl-s"><span class="pl-pds">'</span>filter<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-en">enabled</span>(<span class="pl-s"><span class="pl-pds">'</span>filter<span class="pl-pds">'</span></span>); <span class="pl-c">//return true</span>

<span class="pl-smi">app</span>.<span class="pl-en">disable</span>(<span class="pl-s"><span class="pl-pds">'</span>filter<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-c1">disabled</span>(<span class="pl-s"><span class="pl-pds">'</span>filter<span class="pl-pds">'</span></span>); <span class="pl-c">//return true</span></pre></div>
<p>Developers can load configuration files through the loadConfig method, after loading the parameters will be attached directly to the app object. For example, loading mysql.json file, the specific code is as follows:</p>
<div class="highlight highlight-source-json"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>development<span class="pl-pds">"</span></span>:
    {
      <span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>3306<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>database<span class="pl-pds">"</span></span>:<span class="pl-s"><span class="pl-pds">"</span>pomelo<span class="pl-pds">"</span></span> 
    }
}</pre></div>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">loadConfig</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql.json<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> host <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-smi">mysql</span>.<span class="pl-c1">host</span>; <span class="pl-c">//return 127.0.0.1</span></pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#rules-of-configuration" id="user-content-rules-of-configuration"><span class="octicon octicon-link"></span></a>Rules of Configuration</h2>
<p>The server's configuration is mainly done by the app.configure method, the parameters of the method are as follows:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>([env], [serverType], [<span class="pl-k">function</span>]);</pre></div>
<p>The first two parameters are optional, the parameters' descriptions are as follows:</p>
<ul>
<li>env: runtime environment, can be set as development, production or development | production.</li>
<li>serverType: server type, if set this parameter only this type of server do initialization function, otherwise all servers perform initialization function.</li>
<li>function: the specific initialization operation, it can be any js method.</li>
</ul>
<p>Some configuration examples are as follows:</p>
<h3>
<a aria-hidden="true" class="anchor" href="#example-one" id="user-content-example-one"><span class="octicon octicon-link"></span></a>Example One</h3>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-k">function</span>(){
});</pre></div>
<p>This configuration brings all servers under all modes (development / production) into effect.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#example-two" id="user-content-example-two"><span class="octicon octicon-link"></span></a>Example Two</h3>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
});</pre></div>
<p>This configuration only brings all servers under a fixed mode into effect.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#example-three" id="user-content-example-three"><span class="octicon octicon-link"></span></a>Example Three</h3>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
});</pre></div>
<p>This configuration only brings chat servers under development mode into effect.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#initial-content-examples" id="user-content-initial-content-examples"><span class="octicon octicon-link"></span></a>Initial Content Examples</h3>
<p>Developers can make different configurations for different servers according to various requirements of the application. For example, to configure the startup file of mysql in the global:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
     <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql<span class="pl-pds">'</span></span>, <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>dirname<span class="pl-pds">'</span></span>)<span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">'</span>/config/mysql.json<span class="pl-pds">'</span></span>);
});</pre></div>
<p>Furthermore, you can make configuration on a specific server:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">initArea</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(){
   <span class="pl-c">//area init</span>
};
<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>development|production<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>area<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
     <span class="pl-en">initArea</span>();
});</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#load-components" id="user-content-load-components"><span class="octicon octicon-link"></span></a>Load Components</h2>
<p>Each component has a life cycle, and they are usually loaded during the initialization of application.
Pomelo components include: master, monitor, filter, proxy, handler, remote, server, sync and connection, and their main functions are as follows:</p>
<ul>
<li>master: starting the master server.</li>
<li>monitor: starting each server's monitor service, the service is in charge of collecting information of servers and regularly pushing messages to the master, maintaining the master server's heartbeat connection.</li>
<li>proxy: generating server RPC client, which is essential for server processes comuniation(except master server).</li>
<li>handler: loading handlers in front-end servers.</li>
<li>filter: loading filters for requests service, including filters before and after the calling of rpc.</li>
<li>remote: loading the back-end servers, and generates rpc server.</li>
<li>server: starting service of user requests handling in all servers.</li>
<li>connector: starting session service in front-end servers and receiving user requests.</li>
<li>sync: starting data synchronization service.</li>
<li>connection: starting the service of user connection statistical data.</li>
</ul>
<p>Most of components will be loaded by default, and developers can have custom components depending on the application requirements. Components loading can use the load method, for example:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-c1">load</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">proxy</span>, [options]);  <span class="pl-c">//[options] optional</span></pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#router-configuration" id="user-content-router-configuration"><span class="octicon octicon-link"></span></a>Router Configuration</h2>
<p>The router is mainly responsible for maintaining the routing information, routing calculation, routing result cache, switch routing strategies and update routing information according to the application requirements. Developers can customize different routing rules for different servers, and these can be configured in app.js. For example:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">route</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-smi">routeUtil</span>.<span class="pl-smi">chat</span>);</pre></div>
<p>Developers can also customize routing rules for different servers, for example:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">routeUtil</span>.<span class="pl-en">chat</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">session</span>, <span class="pl-smi">msg</span>, <span class="pl-smi">app</span>, <span class="pl-smi">callback</span>) {
    <span class="pl-k">var</span> chatServers <span class="pl-k">=</span> <span class="pl-smi">app</span>.<span class="pl-en">getServersByType</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>); 
    <span class="pl-k">if</span> (<span class="pl-k">!</span>chatServers) {
        <span class="pl-en">callback</span>(<span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>can not find chat servers.<span class="pl-pds">'</span></span>));
        <span class="pl-k">return</span>;
    }
    <span class="pl-k">var</span> server <span class="pl-k">=</span> <span class="pl-smi">dispatcher</span>.<span class="pl-en">dispatch</span>(<span class="pl-smi">session</span>.<span class="pl-smi">rid</span>, chatServers);
    <span class="pl-en">callback</span>(<span class="pl-c1">null</span>, <span class="pl-smi">server</span>.<span class="pl-c1">id</span>);
};</pre></div>
<p>The callback function returns the id of the server, and here uses the dispatcher on session.rid which just uses the hash processing to do server selection.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#filter-configuration" id="user-content-filter-configuration"><span class="octicon octicon-link"></span></a>Filter Configuration</h2>
<p>When a client request reaches the server, it is processed by filter chain and handlers, and finally generates a response back to the client. The handler implements the business logic, and the filter works for  preparation and rehabilitation to facilitate code modularization and reuse. Pomelo itself provides some filters, and developers can customize filters according to the application requirements.</p>
<ul>
<li>serial: ensuring that all requests from the client to the server will be sent in order.</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">filter</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">filters</span>.<span class="pl-en">serial</span>());</pre></div>
<ul>
<li>time: recording requests response time.</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">filter</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">filters</span>.<span class="pl-c1">time</span>());</pre></div>
<ul>
<li>timeout: monitoring requests response time, if timeout happens it gives a warning.</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">app</span>.<span class="pl-en">filter</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">filters</span>.<span class="pl-en">timeout</span>());</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#complete-reference-sample" id="user-content-complete-reference-sample"><span class="octicon octicon-link"></span></a>Complete Reference Sample</h2>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> pomelo <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>pomelo<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> routeUtil <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./app/util/routeUtil<span class="pl-pds">'</span></span>);
<span class="pl-c">/**</span>
<span class="pl-c"> * Init app for client.</span>
<span class="pl-c"> */</span>
<span class="pl-k">var</span> app <span class="pl-k">=</span> <span class="pl-smi">pomelo</span>.<span class="pl-en">createApp</span>();
<span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>chatofpomelo<span class="pl-pds">'</span></span>);
<span class="pl-smi">app</span>.<span class="pl-en">defaultConfiguration</span>();

<span class="pl-c">// app configure</span>
<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>production|development<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>() {
    <span class="pl-c">// route configures</span>
    <span class="pl-smi">app</span>.<span class="pl-en">route</span>(<span class="pl-s"><span class="pl-pds">'</span>chat<span class="pl-pds">'</span></span>, <span class="pl-smi">routeUtil</span>.<span class="pl-smi">chat</span>);
    <span class="pl-smi">app</span>.<span class="pl-en">route</span>(<span class="pl-s"><span class="pl-pds">'</span>connector<span class="pl-pds">'</span></span>, <span class="pl-smi">routeUtil</span>.<span class="pl-smi">connector</span>);

        <span class="pl-c">// remote configures</span>
    <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>remoteConfig<span class="pl-pds">'</span></span>, {
        cacheMsg<span class="pl-k">:</span> <span class="pl-c1">true</span>, 
        interval<span class="pl-k">:</span> <span class="pl-c1">30</span>
    });

        <span class="pl-c">// filter configures</span>
    <span class="pl-smi">app</span>.<span class="pl-en">filter</span>(<span class="pl-smi">pomelo</span>.<span class="pl-smi">filters</span>.<span class="pl-en">timeout</span>());   

       <span class="pl-c">// mysql configures</span>
        <span class="pl-smi">app</span>.<span class="pl-en">loadConfig</span>(<span class="pl-s"><span class="pl-pds">'</span>mysql<span class="pl-pds">'</span></span>, <span class="pl-smi">app</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>dirname<span class="pl-pds">'</span></span>) <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>/config/mysql.json<span class="pl-pds">'</span></span>);
});

<span class="pl-c">// start app</span>
<span class="pl-smi">app</span>.<span class="pl-c1">start</span>();
</pre></div>
</div>
</div></body></html>