<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo 组件 · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448C:146C389A:5670C0D4" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="e4c6741e10658af607672f7b8c32e76028931117" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#pomelo%E7%BB%84%E4%BB%B6" id="user-content-pomelo组件"><span class="octicon octicon-link"></span></a>Pomelo组件</h1>
<p>组件（component）是纳入服务器生命周期管理的服务单元。Pomelo服务器启动的过程实际上就是加载和启动一些列组件的过程（更多关于组件的细节请参考<a href="https://github.com/NetEase/pomelo/wiki/Pomelo-Framework#-6">这里</a>）。Pomelo框架内部提供了一系列的组件，并默认在启动过程中加载并启动它们，以提供Pomelo中所需的各项服务。本文档将介绍这些内置组件的作用，以及开发者如何对这些组件进行配置。但对于一些不稳定的特性和配置选项暂时先隐藏。</p>
<p>Pomelo内置组件的代码放置在<a href="https://github.com/NetEase/pomelo/tree/master/lib/components">lib/components/</a>目录下。它们当中大部分充当一个包装器角色，将Pomelo框架内部的服务包装后，使之纳入容器的生命周期管理并暴露给外界使用。</p>
<h2>
<a aria-hidden="true" class="anchor" href="#pomelo%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE" id="user-content-pomelo组件配置"><span class="octicon octicon-link"></span></a>Pomelo组件配置</h2>
<p>开发者可以在<code>app.js</code>文件中对各个内置组件进行配置。配置的方式是在app中设置名为 <em>componentName</em>Config的属性，该属性的value将被作为初始化参数传递给组件。其中 <em>componentName</em> 为对应组件的名字。例如，配置<code>connector</code>组件的属性的例子如下：</p>
<pre><code>app.set('connectorConfig', {
  connector: pomelo.connectors.hybridconnector,
  heartbeat: 3,
  useDict: true,
  useProtobuf: true
});
</code></pre>
<p><em>注意</em> :具体的配置参数由对应的组件决定，可能会随组件的升级发生改变。</p>
<h2>
<a aria-hidden="true" class="anchor" href="#%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E" id="user-content-组件说明"><span class="octicon octicon-link"></span></a>组件说明</h2>
<h3>
<a aria-hidden="true" class="anchor" href="#channel" id="user-content-channel"><span class="octicon octicon-link"></span></a>channel</h3>
<p>提供channel相关的服务的组件。加载该组件后，会在app上下文加入<code>channelService</code>，可以通过<code>app.get('channelService')</code>获取。<code>channelService</code>相关的接口信息请参考<a href="http://pomelo.netease.com/api.html">Pomelo API</a>。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AE" id="user-content-配置"><span class="octicon octicon-link"></span></a>配置</h4>
<ul>
<li>broadcastFilter - broadcast的过滤函数。会在执行broadcast操作时，在每个frontend server上，在将消息发送给每个session之前触发。返回true表示可以将消息发送给该session；false则消息将不会发送给对应的session。</li>
</ul>
<h5>
<a aria-hidden="true" class="anchor" href="#%E5%8F%82%E6%95%B0" id="user-content-参数"><span class="octicon octicon-link"></span></a>参数</h5>
<pre><code>* session - 消息将发往的session。
* msg - 待发消息。
* param - broadcast附带参数，在`channelService.broadcast(type, route, {filterParam: param}, cb)`中传递。
</code></pre>
<h4>
<a aria-hidden="true" class="anchor" href="#%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90" id="user-content-使用例子"><span class="octicon octicon-link"></span></a>使用例子</h4>
<pre><code>app.set('channelConfig', {
  broadcastFilter: function(session, msg, param) {
    // check some condition
    return true;
  }
});
</code></pre>
<h3>
<a aria-hidden="true" class="anchor" href="#connection" id="user-content-connection"><span class="octicon octicon-link"></span></a>connection</h3>
<p>无配置项。提供统计frontend server连接数服务的组件，组件名<code>__connection__</code>，在frontend server上会被加载，主要工作是将<code>connectionService</code>封装成组件。<code>pomelo-admin</code>依赖这个组件进行frontend server的连接数和登录用户数进行统计。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#connector" id="user-content-connector"><span class="octicon octicon-link"></span></a>connector</h3>
<p>管理frontend server底层的连接和通信协议的实现，组件名<code>__connector__</code>。配置参数由所使用的connector实现决定。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AE-1" id="user-content-配置-1"><span class="octicon octicon-link"></span></a>配置</h4>
<ul>
<li>connector - connector工厂方法，创建并返回新的connector实例。</li>
</ul>
<h5>
<a aria-hidden="true" class="anchor" href="#%E5%8F%82%E6%95%B0-1" id="user-content-参数-1"><span class="octicon octicon-link"></span></a>参数</h5>
<pre><code>* port - 监听端口
* host - 监听的host名
* opts - 额外初始化参数
</code></pre>
<p>目前Pomelo提供两个connector的实现：<code>sioconnector</code>和<code>hybridconnector</code>。关于这两个connector的更多信息请参考<a href="https://github.com/NetEase/pomelo/wiki/Pomelo-0.3%E6%96%B0%E7%89%B9%E6%80%A7#1-">Pomelo 0.3新特性</a>。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#dictionary" id="user-content-dictionary"><span class="octicon octicon-link"></span></a>dictionary</h3>
<p>生成route字符串压缩编码的组件。该组件会遍历所有handler的route字符串，并为之生成唯一的压缩编码。同时也支持用户配置额外的route字符串，默认配置文件为<code>config/dictionary.json</code>，也可以通过配置来指定该文件的位置。</p>
<p><em>注意</em> <code>dictionary</code>组件只有在Pomelo 0.3版本中使用<code>hybridconnector</code>并且配置<code>useDict</code>为true时才有效。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AE-2" id="user-content-配置-2"><span class="octicon octicon-link"></span></a>配置</h4>
<p>指定用户自定义route字符串配置文件</p>
<pre><code>app.set('dictionaryConfig', {
  dict: path.join(app.getBase(), '/config/dictionary.json')
});
</code></pre>
<h3>
<a aria-hidden="true" class="anchor" href="#backendsession" id="user-content-backendsession"><span class="octicon octicon-link"></span></a>backendSession</h3>
<p>无配置项。提供BackendSession相关服务的组件。加载该组件后，会在app上下文中加入<code>backendSessionService</code>，可以通过<code>app.get('backendSessionService')</code>获取。<code>backendSessionService</code>相关的接口信息请参考<a href="http://pomelo.netease.com/api.html">Pomelo API</a>。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#master" id="user-content-master"><span class="octicon octicon-link"></span></a>master</h3>
<p>无配置项。在master进程上加载。提供master相关功能，如：根据配置启动各个服务器进程，运行<code>pomelo-admin</code>master端并加载master端modules，监控各个进程状态信息等。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#monitor" id="user-content-monitor"><span class="octicon octicon-link"></span></a>monitor</h3>
<p>无配置项。在master之外的各个进程上加载。运行<code>pomelo-admin</code>monitor端并加载monitor端modules。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#protobuf" id="user-content-protobuf"><span class="octicon octicon-link"></span></a>protobuf</h3>
<p>无配置项。该组件负责加载protobuf数据定义文件和提供protobuf相关encode和decode服务（内部使用）。</p>
<p><em>注意</em> <code>protobuf</code>组件只有在Pomelo 0.3版本中使用<code>hybridconnector</code>并且配置<code>useProtobuf</code>为true时才有效。</p>
<p>具体<code>pomelo-protobuf</code>的使用，请参考<a href="https://github.com/pomelonode/pomelo-protobuf">这里</a>。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#proxy" id="user-content-proxy"><span class="octicon octicon-link"></span></a>proxy</h3>
<p>提供rpc客户端代理生成和rpc客户端请求路由计算服务。该模块加载后，会在app上下文加入<code>rpc</code>字段。app.rpc是rpc代理对象的根节点，根据各个服务器路径下<code>remote/</code>目录下的服务代码自动生成，可以通过<code>app.rpc.serverType.service.method</code>的形式发起远程调用。</p>
<p>可以通过<code>app.route</code>方法对特定类型的服务器类型配置路由计算函数。路由计算函数的主要工作就是决定某一个消息应该发往哪一个远程服务器。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E4%BD%BF%E7%94%A8%E4%BE%8B%E5%AD%90-1" id="user-content-使用例子-1"><span class="octicon octicon-link"></span></a>使用例子</h4>
<p>为area服务器配置路由函数routeFn。</p>
<pre><code>app.route('area', routeFn);
</code></pre>
<p>配置默认的路由函数，所有发往没配置路由函数的服务器类型的请求都会交给默认路由函数计算。</p>
<pre><code>app.route('default', defaultRouteFn);
</code></pre>
<p>路由函数的定义：</p>
<pre><code>var routeFn = function(session, msg, app, cb) {
  // 实现路由策略，计算得到目标服务器id
  cb(null, serverId);
};
</code></pre>
<h3>
<a aria-hidden="true" class="anchor" href="#remote" id="user-content-remote"><span class="octicon octicon-link"></span></a>remote</h3>
<p>提供远程服务暴露服务。根据当前服务器类型，加载对应<code>remote/</code>目录下的服务器代码，并根据配置的端口将远程服务暴露出来。该模块启动后，其他服务器即可连接配置的端口，向当前服务器发起rpc调用。</p>
<p>更多关于<code>pomelo-rpc</code>的使用细节，请参考<a href="https://github.com/NetEase/pomelo-rpc">这里</a>。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#server" id="user-content-server"><span class="octicon octicon-link"></span></a>server</h3>
<p><code>server</code>模块使服务器具备处理客户端请求的能力。该模块主要实现了filter服务，根据当前服务器类型，加载对应<code>handler/</code>目录下的代码，并决定一个请求应该是在当前服务器处理还是应该路由给其他服务器处理。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#session" id="user-content-session"><span class="octicon octicon-link"></span></a>session</h3>
<p>无配置项。提供globalSession相关服务的组件。加载该组件后，会在app上下文中加入<code>sessionService</code>，可以通过<code>app.get('sessionService')</code>获取。<code>sessionService</code>相关的接口信息请参考<a href="http://pomelo.netease.com/api.html">Pomelo API</a>。</p>
<h3>
<a aria-hidden="true" class="anchor" href="#sync" id="user-content-sync"><span class="octicon octicon-link"></span></a>sync</h3>
<p>提供定时同步内存数据到数据库的服务。该组件加载后会在app向下文中加上<code>sync</code>属性，可以通过<code>app.get('sync')</code>来获取。</p>
<h4>
<a aria-hidden="true" class="anchor" href="#%E9%85%8D%E7%BD%AE-3" id="user-content-配置-3"><span class="octicon octicon-link"></span></a>配置</h4>
<p>配置sync组件</p>
<pre><code>app.load(pomelo.sync, {path:__dirname + '/app/dao/mapping', dbclient: dbclient});
</code></pre>
<p>其中，<code>path</code>是实现底层数据同步服务器的目录。<code>sync</code>会加载该目录下所有服务，并建立映射关系。<code>dbclient</code>是用来实现数据同步服务的回调参数。</p>
<p>数据同步服务示例</p>
<pre><code>module.exports = {
  updateBag: function (dbclient, val, cb) {
    var sql = 'update Bag set items = ? where id = ?';
    var items = val.items;
    if (typeof items !== 'string') {
      items = JSON.stringify(items);
    }
    var args = [items, val.id];

    dbclient.query(sql, args, function (err, res) {
      if (err) {
        console.error('write mysql failed!　' + sql + ' ' + JSON.stringify(val));
      }
      cb(!!err);
    });
  }
};
</code></pre>
<p>通过sync更新数据</p>
<pre><code>app.get('sync').exec('bagSync.updateBag', player.bag.id, player.bag);
</code></pre>
<p>更多关于<code>pomelo-sync</code>的使用细节，请参考<a href="https://github.com/NetEase/pomelo-sync">这里</a>。</p>
</div>
</div></body></html>