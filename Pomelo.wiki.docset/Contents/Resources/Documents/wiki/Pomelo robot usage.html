<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo robot usage · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:4489:F58CE68:5670C0B5" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="e46ddee7c80e32cc81695c9885da6d54074b60d8" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#pomelo-robot" id="user-content-pomelo-robot"><span class="octicon octicon-link"></span></a>pomelo-robot</h1>
<p>pomelo-robot is a performance test tool used for testing the pomelo game server framework, also can test performance of the other services based on socket.io or socket. 
This module can be used standalone or distributed test modes. </p>
<h1>
<a aria-hidden="true" class="anchor" href="#function" id="user-content-function"><span class="octicon octicon-link"></span></a>Function</h1>
<p>This module's function is performance test and analysis for the game project automatically. It provides robot and script to game server, finally outputs performance test and analysis report. 
Module pomelo-robot runs user-defined JS script in a sandbox. In the process of running, clients will report data to the master node automatically. The master node refine and summarize all the nodes' test data. The master node calculates the average response time and some other statistics, and sends statistic data regularly to the built-in HTTP server to display in the web. </p>
<h1>
<a aria-hidden="true" class="anchor" href="#module-structure" id="user-content-module-structure"><span class="octicon octicon-link"></span></a>Module structure</h1>
<p>Module's internal operating structure is as follows: </p>
<p><img alt="" data-canonical-src="https://raw.github.com/palmtoy/ImageBucket/master/Pomelo/Robot/1.jpg" src="https://camo.githubusercontent.com/c39083c4053b86c23e9bcaba71608e2233583a4a/68747470733a2f2f7261772e6769746875622e636f6d2f70616c6d746f792f496d6167654275636b65742f6d61737465722f506f6d656c6f2f526f626f742f312e6a7067"/></p>
<p>"Master" is responsible for collecting all the running data of "Client" and show results. <br> 
"Client" is responsible for runnint custom script in multiple sandboxs("User"), reporting running data to the "Master" at the same time. </br></p>
<h2>
<a aria-hidden="true" class="anchor" href="#example-of-use" id="user-content-example-of-use"><span class="octicon octicon-link"></span></a>Example of use</h2>
<p>Let's create a Node.js test project. The project directory structure is as shown below: <br> </br></p>
<p><img alt="" data-canonical-src="https://raw.github.com/palmtoy/ImageBucket/master/Pomelo/Robot/2.jpg" src="https://camo.githubusercontent.com/7bfa022d9c00dfc818a57c8eda24e78c32cb44bc/68747470733a2f2f7261772e6769746875622e636f6d2f70616c6d746f792f496d6167654275636b65742f6d61737465722f506f6d656c6f2f526f626f742f322e6a7067"/></p>
<p>Installation of dependent libraries: <br> </br></p>
<div class="highlight highlight-source-js"><pre>npm install pomelo<span class="pl-k">-</span>robot</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#configjson-configuration" id="user-content-configjson-configuration"><span class="octicon octicon-link"></span></a>config.json configuration</h3>
<p>"config.json" is divided into two kinds of running environments: development(dev) and production(prod) environments. "prod" environment's file content is as follows: </p>
<div class="highlight highlight-source-js"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>master<span class="pl-pds">"</span></span><span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>host<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>127.0.0.1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>port<span class="pl-pds">"</span></span><span class="pl-k">:</span><span class="pl-c1">8888</span>, <span class="pl-s"><span class="pl-pds">"</span>webport<span class="pl-pds">"</span></span><span class="pl-k">:</span><span class="pl-c1">8889</span>, <span class="pl-s"><span class="pl-pds">"</span>interval<span class="pl-pds">"</span></span><span class="pl-k">:</span><span class="pl-c1">500</span>},
}</pre></div>
<p>"master": master server IP, communication ports with client, web interface port, running a custom JS script's interval(such as: lord.js). <br> </br></p>
<h3>
<a aria-hidden="true" class="anchor" href="#to-implement-a-custom-configuration-script" id="user-content-to-implement-a-custom-configuration-script"><span class="octicon octicon-link"></span></a>To implement a custom configuration script</h3>
<h5>
<a aria-hidden="true" class="anchor" href="#in-the-envjson-configuring-custom-script-path" id="user-content-in-the-envjson-configuring-custom-script-path"><span class="octicon octicon-link"></span></a>In the "env.json", configuring custom script path:<br>
</br></h5>
<div class="highlight highlight-source-js"><pre>{
  <span class="pl-s"><span class="pl-pds">"</span>env<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>prod<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>script<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>/app/script/lord.js<span class="pl-pds">"</span></span>
}</pre></div>
<h5>
<a aria-hidden="true" class="anchor" href="#to-implement-custom-script-lordjs" id="user-content-to-implement-custom-script-lordjs"><span class="octicon octicon-link"></span></a>To implement custom script "lord.js":</h5>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// ...</span>
<span class="pl-c">// check mysql client user and password near line 387</span>
<span class="pl-k">var</span> client <span class="pl-k">=</span> <span class="pl-smi">mysql</span>.<span class="pl-en">createConnection</span> ({ ...
<span class="pl-c">// ...</span>
<span class="pl-k">var</span> queryHero <span class="pl-k">=</span> <span class="pl-c1">require</span>(cwd <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>/app/data/mysql<span class="pl-pds">'</span></span>).<span class="pl-smi">queryHero</span>;
<span class="pl-c">// ...</span>
<span class="pl-k">function</span> <span class="pl-en">entry</span>(<span class="pl-smi">host</span>, <span class="pl-smi">port</span>, <span class="pl-smi">token</span>, <span class="pl-smi">callback</span>) {
  <span class="pl-c">// ...</span>
  <span class="pl-c">// initialize socketClient</span>
  <span class="pl-smi">pomelo</span>.<span class="pl-en">init</span>({host<span class="pl-k">:</span> host, port<span class="pl-k">:</span> port, log<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>() {
    <span class="pl-smi">pomelo</span>.<span class="pl-en">request</span>(<span class="pl-s"><span class="pl-pds">'</span>connector.entryHandler.entry<span class="pl-pds">'</span></span>, {token<span class="pl-k">:</span> token}, <span class="pl-k">function</span>(<span class="pl-smi">data</span>) {
      <span class="pl-c">// ...</span>
      <span class="pl-en">afterLogin</span>(pomelo,data);
    });
  });
}
<span class="pl-c">// ...</span></pre></div>
<p>In "/app/data/mysql.js", the code which is looking for the login roles is as follows: </p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// ...</span>
<span class="pl-en">queryHero</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">client</span>,<span class="pl-smi">limit</span>,<span class="pl-smi">offset</span>,<span class="pl-smi">cb</span>){
    <span class="pl-k">var</span> users <span class="pl-k">=</span> [];
    <span class="pl-k">var</span> sql <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>SELECT User.* FROM User,Player where User.id = Player.userId and User.name like 'pomelo%' limit ? offset ? <span class="pl-pds">"</span></span>;
    <span class="pl-c">// ...</span>
};
<span class="pl-c">// ...</span></pre></div>
<p>The above code is running in a sandbox. Firstly, a role logins game server. After the role's login, we call the "afterLogin" function. Users can do some follow-up related operations. <br> </br></p>
<h3>
<a aria-hidden="true" class="anchor" href="#the-entry-fileappjs" id="user-content-the-entry-fileappjs"><span class="octicon octicon-link"></span></a>The entry file:"app.js"</h3>
<p>"app.js" can judge according to launch parameters to start the "master" or "client" services. <br> </br></p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> envConfig <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./app/config/env.json<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> config <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./app/config/<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">envConfig</span>.<span class="pl-smi">env</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>/config<span class="pl-pds">'</span></span>);
<span class="pl-c">//...</span>
<span class="pl-k">if</span> (mode <span class="pl-k">===</span> <span class="pl-s"><span class="pl-pds">'</span>master<span class="pl-pds">'</span></span>) {
    <span class="pl-smi">robot</span>.<span class="pl-en">runMaster</span>(<span class="pl-c1">__filename</span>);
} <span class="pl-k">else</span> {
    <span class="pl-k">var</span> script <span class="pl-k">=</span> (<span class="pl-smi">process</span>.<span class="pl-en">cwd</span>() <span class="pl-k">+</span> <span class="pl-smi">envConfig</span>.<span class="pl-smi">script</span>);
    <span class="pl-smi">robot</span>.<span class="pl-en">runAgent</span>(script);
}
<span class="pl-c">// ...</span></pre></div>
<p>Specific code can refer to <a href="https://github.com/NetEase/pomelo-robot-demo">pomelo-robot-demo</a>. <br/></p>
<h3>
<a aria-hidden="true" class="anchor" href="#run-the-test" id="user-content-run-the-test"><span class="octicon octicon-link"></span></a>Run the test</h3>
<p>You can run the following commands to start the "master" service: <br> 
"node app.js master" <br>
Open a browser to access "http://masterIp:8889" <br> </br></br></br></p>
<p>You can run the following commands to start the "client" service: <br> 
"node app.js client" <br>
Note: You can start "client" services on multiple machines to do performance and stress testing. </br></br></p>
<p>Web interface will display the number of "client" which connects to the "master". You can configure the the number of the sandbox for each "client" at the column of "Per Agent Users". You can click on the "Go" button to notify all of the clients began to run. The Web interface will obtain the background data regularly to display. <br> 
Running interface as shown below: <br> </br></br></p>
<p><img alt="" data-canonical-src="https://raw.github.com/palmtoy/ImageBucket/master/Pomelo/Robot/3.jpg" src="https://camo.githubusercontent.com/930378944b04b9ecad6f2cb1c0b9783a033c22f5/68747470733a2f2f7261772e6769746875622e636f6d2f70616c6d746f792f496d6167654275636b65742f6d61737465722f506f6d656c6f2f526f626f742f332e6a7067"> </img></p>
<p><img alt="" data-canonical-src="https://raw.github.com/palmtoy/ImageBucket/master/Pomelo/Robot/4.jpg" src="https://camo.githubusercontent.com/13e963d6897da78e1f550c15dd039f21d4352816/68747470733a2f2f7261772e6769746875622e636f6d2f70616c6d746f792f496d6167654275636b65742f6d61737465722f506f6d656c6f2f526f626f742f342e6a7067"> </img></p>
<h3>
<a aria-hidden="true" class="anchor" href="#other" id="user-content-other"><span class="octicon octicon-link"></span></a>Other</h3>
<p>Please refer to the source code <a href="https://github.com/NetEase/pomelo-robot">pomelo-robot</a> </p>
</div>
</div></body></html>