<html><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
<meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="en" http-equiv="Content-Language">
<meta content="width=1020" name="viewport">
<title>Pomelo 0.4 new features · NetEase/pomelo Wiki · GitHub</title>
<link href="/opensearch.xml" rel="search" title="GitHub" type="application/opensearchdescription+xml">
<link href="src/ad667adaa2cfe8f3caa4a41b7d0a79a1.png" rel="fluid-icon" title="GitHub">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="57x57">
<link href="src/a10d19ff5f738940a7a5086be334f50b.png" rel="apple-touch-icon" sizes="114x114">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="72x72">
<link href="src/b4cd268bc600cc14d2cdd557de6da2fb.png" rel="apple-touch-icon" sizes="144x144">
<meta content="1401488693436528" property="fb:app_id">
<meta content="@github" name="twitter:site"/><meta content="summary" name="twitter:card"/><meta content="NetEase/pomelo" name="twitter:title"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="twitter:description"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" name="twitter:image:src"/>
<meta content="GitHub" property="og:site_name"/><meta content="object" property="og:type"/><meta content="https://avatars0.githubusercontent.com/u/1460597?v=3&amp;s=400" property="og:image"/><meta content="NetEase/pomelo" property="og:title"/><meta content="https://github.com/NetEase/pomelo" property="og:url"/><meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." property="og:description"/>
<meta content="https://api.github.com/_private/browser/stats" name="browser-stats-url">
<meta content="https://api.github.com/_private/browser/errors" name="browser-errors-url">
<link href="https://assets-cdn.github.com/" rel="assets">
<meta content="1000" name="pjax-timeout">
<meta content="/windows-tile.png" name="msapplication-TileImage">
<meta content="#ffffff" name="msapplication-TileColor">
<meta data-pjax-transient="" name="selected-link" value="repo_wiki">
<meta content="KT5gs8h0wvaagLKAVWq8bbeNwnZZK1r1XQysX3xurLU" name="google-site-verification">
<meta content="UA-3769691-2" name="google-analytics">
<meta content="collector.githubapp.com" name="octolytics-host"/><meta content="github" name="octolytics-app-id"/><meta content="CA86616A:448A:120939AF:5670C067" name="octolytics-dimension-request_id"/>
<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/wiki/show" data-pjax-transient="true" name="analytics-location"/>
<meta content="Rails, view, wiki#show" data-pjax-transient="true" name="analytics-event"/>
<meta class="js-ga-set" content="Logged Out" name="dimension1">
<meta content="github.com" name="hostname">
<meta content="" name="user-login">
<meta content="github.com" name="expected-hostname">
<link color="#4078c0" href="https://assets-cdn.github.com/pinned-octocat.svg" rel="mask-icon">
<link href="https://assets-cdn.github.com/favicon.ico" rel="icon" type="image/x-icon">
<meta content="a8291cf4e23ce7e6dfb73f2c02b67e8fd88b2731" name="form-nonce"/>
<link crossorigin="anonymous" href="src/350888e1495e7af27e01faa9d8291dee.css" media="all" rel="stylesheet"/>
<link crossorigin="anonymous" href="src/9fae9b7d8f0785d745a43c6465f74ae5.css" media="all" rel="stylesheet"/>
<meta content="cd9958d45e48e8e3157a320e9c346eaa" http-equiv="x-pjax-version">
<meta content="pomelo - A fast,scalable,distributed game server framework for Node.js." name="description">
<meta content="github.com/NetEase/pomelo git https://github.com/NetEase/pomelo.git" name="go-import">
<meta content="1460597" name="octolytics-dimension-user_id"/><meta content="NetEase" name="octolytics-dimension-user_login"/><meta content="5880912" name="octolytics-dimension-repository_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_nwo"/><meta content="true" name="octolytics-dimension-repository_public"/><meta content="false" name="octolytics-dimension-repository_is_fork"/><meta content="5880912" name="octolytics-dimension-repository_network_root_id"/><meta content="NetEase/pomelo" name="octolytics-dimension-repository_network_root_nwo"/>
<link href="https://github.com/NetEase/pomelo/commits/master.atom" rel="alternate" title="Recent Commits to pomelo:master" type="application/atom+xml">
</link></meta></meta></meta></link></link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></meta></meta></meta></link></link></link></link></link></link></meta></meta></meta></meta></head><body style="padding:0 25px;"><div class="gollum-markdown-content instapaper_body" id="wiki-body">
<div class="markdown-body">
<h1>
<a aria-hidden="true" class="anchor" href="#new-features-in-pomelo-04" id="user-content-new-features-in-pomelo-04"><span class="octicon octicon-link"></span></a>New features in Pomelo 0.4</h1>
<p>Pomelo 0.4 makes structural changes to support more friendly custom communication protocol, and provides custom data transmission strategies for different situations.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#custom-protocol" id="user-content-custom-protocol"><span class="octicon octicon-link"></span></a>Custom protocol</h2>
<h3>
<a aria-hidden="true" class="anchor" href="#implementation-of-server-side" id="user-content-implementation-of-server-side"><span class="octicon octicon-link"></span></a>Implementation of server side</h3>
<p>Pomelo 0.4 makes a more detailed protocol division to support more flexible custom features. The main structure is as follow chart: </p>
<img alt="pomelo-transport" data-canonical-src="http://pomelo.netease.com/resource/documentImage/pomelo-transport.png" src="https://camo.githubusercontent.com/754e018b700d7303646ba1e1d2ae703203babbaf/687474703a2f2f706f6d656c6f2e6e6574656173652e636f6d2f7265736f757263652f646f63756d656e74496d6167652f706f6d656c6f2d7472616e73706f72742e706e67">
<p>We add the protocol layer to encode/decode data packages between the upper layer and the under layer. The protocol layer is mainly in charge of encoding and decoding transmission data for the upper layer, and is associated with specific connector. Hybridconnector is responsible for dealing with data from the message layer, and sioconnector is responsible for dealing with data from the socket.io layer.</p>
<p>Encoding and decoding algorithm in the protocol layer can be custom made by passing it to connector, code example is as follow:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">encode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">reqId</span>, <span class="pl-smi">route</span>, <span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized encode with reqId, route and msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return encode result</span>
};

<span class="pl-k">var</span> <span class="pl-en">decode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized decode with msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return decode result</span>
};

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>production|development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>connector<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
    connector <span class="pl-k">:</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">connectors</span>.<span class="pl-smi">hybridconnector</span>,
    encode<span class="pl-k">:</span> encode,
    decode<span class="pl-k">:</span> decode
  });
});</pre></div>
<p>When data comes to a connector, corresponding encode and decode methods will be invoked.</p>
<ul>
<li><p><code>encode(reqId, route, msg)</code> - means encoding <code>reqId</code>, <code>route</code> and <code>msg</code>. We can know package type by checking <code>reqId</code>, if <code>reqId &gt; 0</code> it represents request message, if <code>reqId === 0</code> it represents push message. And this method's return value is the result of encoding message, which will be passed to the transmission layer to send out.</p></li>
<li><p><code>decode(msg)</code> - is responsible for decoding messages from the under layer. <code>msg</code> is the data that the under layer receives, which is in accordance with the data in the same layer of client side. This method's return value is the result of decoding message, which can be handle by the upper layer, and it format is :　{id: id, route: route, body: body}． In this kind of message, id is the identity of message, request message's id must be positive integer, notify message does not have this field, the type of route field is string which means message router, the type of body field is object which means message body.</p></li>
</ul>
<p>We can get default encode and decode method by <code>pomelo.connectors.hybridconnector.encode/decode</code> and  <code>pomelo.connectors.sioconnector.encode/decode</code>.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#implementation-of-js-client" id="user-content-implementation-of-js-client"><span class="octicon octicon-link"></span></a>Implementation of JS client</h3>
<p>Client side is similar to server side, which also provides corresponding custom parameters, code example is as follow:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">encode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">reqId</span>, <span class="pl-smi">route</span>, <span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized encode with reqId, route and msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return encode result</span>
};

<span class="pl-k">var</span> <span class="pl-en">decode</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">msg</span>) {
  <span class="pl-c">// do some customized decode with msg</span>
  <span class="pl-k">return</span> result;    <span class="pl-c">// return decode result</span>
};

<span class="pl-smi">pomelo</span>.<span class="pl-en">init</span>({
  host<span class="pl-k">:</span> host, 
  port<span class="pl-k">:</span> port, 
  log<span class="pl-k">:</span> <span class="pl-c1">true</span>, 
  encode<span class="pl-k">:</span> encode, 
  decode<span class="pl-k">:</span> decode}, <span class="pl-k">function</span>() {
});</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#schedule-of-data-transmission" id="user-content-schedule-of-data-transmission"><span class="octicon octicon-link"></span></a>Schedule of data transmission</h2>
<p>As we can see from the chart above, there is the scheduler layer between the protocol layer and the transport layer.</p>
<p>The scheduler layer is deciding the data sending strategy, for example, the sending priority and batch operations in broadcasting messages.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">SchedulerService</span> <span class="pl-k">=</span> <span class="pl-k">function</span>() {
};

<span class="pl-c1">SchedulerService</span>.<span class="pl-c1">prototype</span>.<span class="pl-en">schedule</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">route</span>, <span class="pl-smi">msg</span>, <span class="pl-smi">recvs</span>, <span class="pl-smi">opts</span>, <span class="pl-smi">cb</span>) {
  <span class="pl-c">// do the schedule</span>
};

<span class="pl-smi">app</span>.<span class="pl-en">configure</span>(<span class="pl-s"><span class="pl-pds">'</span>production|development<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>connector<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(){
  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>schedulerConfig<span class="pl-pds">'</span></span>, {
    scheduler<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">SchedulerService</span>()
  });
});</pre></div>
<p>schedule(route, msg, recvs, opts, cb) is responsible for implementation of schedule strategy. You can use <code>sessionService.sendMessage</code> to send messages in schedule method.</p>
<ul>
<li>route - message router, and in response message this field is null.</li>
<li>msg - messages after encoding.</li>
<li>recvs - receivers's session.id list.</li>
<li>opts - additional parameters. opts.isBroadcast means the message is need to do broadcast operation，opts.isResponse means the message is need to do response operation，opts.isPush means the message is need to do push operation.</li>
</ul>
<p>Pomelo provides two kinds of scheduler.</p>
<ul>
<li>
<code>pomelo.schedulers.direct</code> - Default scheduler，which will send messages directly.</li>
<li>
<code>pomelo.schedulers.buffer</code> - Optional scheduler, which will cache messages and send messages in batch. You can adjust messages sending interval by modifying <code>flushInterval</code>, and its default value is 20ms.</li>
</ul>
<h2>
<a aria-hidden="true" class="anchor" href="#hybridconnector-heartbeat-timeout" id="user-content-hybridconnector-heartbeat-timeout"><span class="octicon octicon-link"></span></a>HybridConnector heartbeat timeout</h2>
<p>In Pomelo 0.3 <code>hybridconnector</code> will not close the connection after heartbeat timeout. In Pomelo 0.4.2, we add the option <code>disconnectOnTimeout</code>, when the server side detecting heartbeat timeout it will close the client connection, code example is as follow:</p>
<div class="highlight highlight-source-js"><pre>  <span class="pl-smi">app</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>connectorConfig<span class="pl-pds">'</span></span>, {
    connector <span class="pl-k">:</span> <span class="pl-smi">pomelo</span>.<span class="pl-smi">connectors</span>.<span class="pl-smi">hybridconnector</span>,
    heartbeat <span class="pl-k">:</span> <span class="pl-c1">3</span>,
    disconnectOnTimeout<span class="pl-k">:</span> <span class="pl-c1">true</span>
  });   </pre></div>
</img></div>
</div></body></html>